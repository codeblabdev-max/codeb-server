# CodeB CLI v7.0 CI/CD Pipeline
# Publish to GitHub Package Registry + Minio Direct Download
# Self-hosted Runner with Minio Cache

name: CodeB CLI v7.0 CI

on:
  push:
    branches: [main]
    paths:
      - 'cli/**'
      - 'VERSION'
    tags:
      - 'v7.*'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  MINIO_BUCKET: build-cache

jobs:
  # CLI ë¹Œë“œ ë° ê²€ì¦ (Self-hosted Runner with Minio Cache)
  build-verify:
    name: Build & Verify CLI
    runs-on: self-hosted

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Building version: $VERSION"

      - name: Generate cache hash
        id: cache
        run: |
          NPM_HASH=$(md5sum cli/package-lock.json | cut -d' ' -f1 | head -c8)
          echo "npm_hash=$NPM_HASH" >> $GITHUB_OUTPUT

      - name: Setup Minio CLI
        run: |
          if ! command -v mc &> /dev/null; then
            curl -sO https://dl.min.io/client/mc/release/linux-amd64/mc
            chmod +x mc && sudo mv mc /usr/local/bin/
          fi
          mc alias set codeb ${{ secrets.MINIO_ENDPOINT }} ${{ secrets.MINIO_ACCESS_KEY }} ${{ secrets.MINIO_SECRET_KEY }} --api S3v4 2>/dev/null || true

      - name: Restore npm cache from Minio
        run: |
          CACHE_KEY="codeb-cli/npm-${{ steps.cache.outputs.npm_hash }}.tar.gz"
          if mc stat codeb/${{ env.MINIO_BUCKET }}/$CACHE_KEY > /dev/null 2>&1; then
            echo "ğŸ”„ Restoring npm cache..."
            mc cp codeb/${{ env.MINIO_BUCKET }}/$CACHE_KEY /tmp/npm-cache.tar.gz
            mkdir -p ~/.npm
            tar -xzf /tmp/npm-cache.tar.gz -C ~/.npm 2>/dev/null || true
            rm -f /tmp/npm-cache.tar.gz
            echo "âœ… npm cache restored"
          fi

      - name: Sync version to package.json
        working-directory: ./cli
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          jq --arg v "$VERSION" '.version = $v' package.json > package.tmp.json
          mv package.tmp.json package.json
          echo "âœ… package.json version synced to $VERSION"

      - name: Install dependencies
        working-directory: ./cli
        run: npm ci

      - name: Verify CLI
        working-directory: ./cli
        run: |
          echo "âœ… Build successful"
          echo "ğŸ“¦ Package info:"
          cat package.json | grep -E '"name"|"version"'

      - name: Save npm cache to Minio
        if: always()
        run: |
          CACHE_KEY="codeb-cli/npm-${{ steps.cache.outputs.npm_hash }}.tar.gz"
          if [ -d ~/.npm ]; then
            tar -czf /tmp/npm-cache.tar.gz -C ~ .npm
            mc cp /tmp/npm-cache.tar.gz codeb/${{ env.MINIO_BUCKET }}/$CACHE_KEY 2>/dev/null || true
            rm -f /tmp/npm-cache.tar.gz
          fi

  # GitHub Package Registry ë°œí–‰
  publish:
    name: Publish to GitHub Packages
    runs-on: self-hosted
    needs: build-verify
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://npm.pkg.github.com'
          scope: '@codeblabdev-max'

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Sync version to package.json
        working-directory: ./cli
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          jq --arg v "$VERSION" '.version = $v' package.json > package.tmp.json
          mv package.tmp.json package.json

      - name: Install dependencies
        working-directory: ./cli
        run: npm ci

      - name: Publish to GitHub Packages
        working-directory: ./cli
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Upload CLI/MCP binaries to Minio for Direct Download
  upload-binaries:
    name: Upload Binaries to Minio
    runs-on: self-hosted
    needs: [build-verify, publish]
    if: always() && needs.build-verify.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Read version
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Sync version to all packages
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd cli && jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json && cd ..
          cd cli/mcp-proxy && jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json && cd ../..

      - name: Install CLI dependencies
        working-directory: ./cli
        run: npm ci

      - name: Setup Minio CLI
        run: |
          if ! command -v mc &> /dev/null; then
            curl -sO https://dl.min.io/client/mc/release/linux-amd64/mc
            chmod +x mc && sudo mv mc /usr/local/bin/
          fi
          mc alias set codeb ${{ secrets.MINIO_ENDPOINT }} ${{ secrets.MINIO_ACCESS_KEY }} ${{ secrets.MINIO_SECRET_KEY }} --api S3v4

      - name: Create Minio release bucket
        run: mc mb codeb/releases 2>/dev/null || true

      - name: Package CLI for direct download
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p /tmp/codeb-release
          cp -r cli/bin /tmp/codeb-release/
          cp -r cli/src /tmp/codeb-release/
          cp -r cli/commands /tmp/codeb-release/
          cp -r cli/rules /tmp/codeb-release/
          cp -r cli/skills /tmp/codeb-release/
          cp -r cli/scripts /tmp/codeb-release/
          cp cli/package.json /tmp/codeb-release/
          cp cli/package-lock.json /tmp/codeb-release/
          mkdir -p /tmp/codeb-release/mcp-proxy
          cp -r cli/mcp-proxy/* /tmp/codeb-release/mcp-proxy/
          cp VERSION /tmp/codeb-release/
          cd /tmp && tar -czf codeb-cli-${VERSION}.tar.gz codeb-release
          echo "ğŸ“¦ Created codeb-cli-${VERSION}.tar.gz"
          ls -lh codeb-cli-${VERSION}.tar.gz

      - name: Upload CLI to Minio
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mc cp /tmp/codeb-cli-${VERSION}.tar.gz codeb/releases/cli/codeb-cli-${VERSION}.tar.gz
          mc cp /tmp/codeb-cli-${VERSION}.tar.gz codeb/releases/cli/codeb-cli-latest.tar.gz
          echo "{\"version\": \"${VERSION}\", \"updated\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > /tmp/version.json
          mc cp /tmp/version.json codeb/releases/cli/version.json
          echo "âœ… CLI uploaded to Minio"

      - name: Upload install scripts to Minio
        run: |
          mc cp cli/scripts/minio-install.sh codeb/releases/cli/install.sh
          mc cp cli/scripts/project-update.sh codeb/releases/cli/project-update.sh
          echo "âœ… Install scripts uploaded"

      - name: Cleanup
        if: always()
        run: rm -rf /tmp/codeb-release /tmp/codeb-cli-*.tar.gz /tmp/version.json 2>/dev/null || true

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ CodeB CLI v${VERSION} Release Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Œ GitHub Packages:"
          echo "   npm install -g @codeblabdev-max/we-cli@${VERSION}"
          echo ""
          echo "ğŸ“Œ Direct Download:"
          echo "   curl -sSL https://releases.codeb.kr/cli/install.sh | bash"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
