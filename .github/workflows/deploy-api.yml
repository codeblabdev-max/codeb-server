# CodeB v6.0 HTTP API Server Deployment
# Deploys to api.codeb.kr (158.247.203.55)

name: Deploy API Server

on:
  push:
    branches: [main]
    paths:
      - 'v6.0/mcp-server/**'
      - 'v6.0/VERSION'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20.x'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/codeb-api

jobs:
  # Build: Self-hosted runner on App server (has Podman + buildah)
  build:
    name: Build & Push Docker Image
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.version.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat v6.0/VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build image with Podman
        run: |
          sudo podman build --no-cache \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            -f ./v6.0/mcp-server/Dockerfile \
            ./v6.0/mcp-server

      - name: Push image
        run: |
          sudo podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          sudo podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  # Deploy: Self-hosted runner (same server, direct deployment)
  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    needs: build
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          VERSION=$(cat v6.0/VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Stop legacy node service (migration to container)
        run: |
          # One-time migration: stop legacy systemd node service
          # This can be removed after first successful container deployment
          if sudo systemctl is-active codeb-mcp-api.service 2>/dev/null; then
            echo "‚ö†Ô∏è Stopping legacy node service for container migration..."
            sudo systemctl stop codeb-mcp-api.service
            sudo systemctl disable codeb-mcp-api.service
            echo "‚úÖ Legacy service stopped and disabled"
          else
            echo "‚ÑπÔ∏è No legacy service running (already containerized)"
          fi

      - name: Deploy CodeB API
        run: |
          set -e
          VERSION="${{ steps.version.outputs.version }}"

          echo "üöÄ Deploying CodeB API v$VERSION..."

          # Stop existing container (if running) - use sudo for root containers
          # Note: Container name is codeb-mcp-api to avoid conflict with codeb-api (Project Generator)
          sudo podman stop codeb-mcp-api 2>/dev/null || true
          sudo podman rm codeb-mcp-api 2>/dev/null || true

          # Force pull the new image (avoid using cached local image)
          echo "üì• Pulling image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION"
          sudo podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION

          # Load DB credentials from existing env file
          source /opt/codeb/mcp-server/.env 2>/dev/null || true

          # Run new container
          sudo podman run -d \
            --name codeb-mcp-api \
            --restart always \
            -p 9101:9101 \
            -e NODE_ENV=production \
            -e PORT=9101 \
            -e LOG_DIR=/app/logs \
            -e CODEB_DB_HOST="${CODEB_DB_HOST:-db.codeb.kr}" \
            -e CODEB_DB_PORT="${CODEB_DB_PORT:-5432}" \
            -e CODEB_DB_NAME="${CODEB_DB_NAME:-codeb}" \
            -e CODEB_DB_USER="${CODEB_DB_USER:-codeb}" \
            -e CODEB_DB_PASSWORD="${CODEB_DB_PASSWORD}" \
            -v /opt/codeb/logs:/app/logs \
            -v /opt/codeb/registry:/opt/codeb/registry \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION

          # Health check
          echo "‚è≥ Waiting for health check..."
          sleep 5

          for i in 1 2 3 4 5; do
            if curl -sf http://localhost:9101/health; then
              echo ""
              echo "‚úÖ Health check passed!"
              break
            fi
            echo "Retry $i/5..."
            sleep 2
          done

          # Verify version
          DEPLOYED_VERSION=$(curl -sf http://localhost:9101/health | jq -r '.version')
          if [ "$DEPLOYED_VERSION" = "$VERSION" ]; then
            echo "‚úÖ Version verified: $DEPLOYED_VERSION"
          else
            echo "‚ö†Ô∏è Version mismatch: expected $VERSION, got $DEPLOYED_VERSION"
          fi

          echo "‚úÖ Deployment complete!"

      - name: Verify external access
        run: |
          sleep 5
          curl -sf https://api.codeb.kr/health && echo "‚úÖ External access OK" || echo "‚ö†Ô∏è External access check failed"
