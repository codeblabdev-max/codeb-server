# CodeB v6.0 HTTP API Server Deployment
# Deploys to api.codeb.kr (158.247.203.55)

name: Deploy API Server

on:
  push:
    branches: [main]
    paths:
      - 'v6.0/mcp-server/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20.x'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/codeb-api

jobs:
  # Build: Self-hosted runner on App server (has Podman + buildah)
  build:
    name: Build & Push Docker Image
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.version.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat v6.0/VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build image with Podman
        run: |
          podman build \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            -f ./v6.0/mcp-server/Dockerfile \
            ./v6.0/mcp-server

      - name: Push image
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  # Deploy: Self-hosted runner (same server, direct deployment)
  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    needs: build
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          VERSION=$(cat v6.0/VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Deploy CodeB API
        run: |
          set -e
          VERSION="${{ steps.version.outputs.version }}"

          echo "üöÄ Deploying CodeB API v$VERSION..."

          # Stop existing container (if running)
          podman stop codeb-api 2>/dev/null || true
          podman rm codeb-api 2>/dev/null || true

          # Run new container from local image
          podman run -d \
            --name codeb-api \
            --restart always \
            -p 9101:9101 \
            -e NODE_ENV=production \
            -e PORT=9101 \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -v /opt/codeb/logs:/app/logs \
            -v /opt/codeb/registry:/opt/codeb/registry \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION

          # Health check
          echo "‚è≥ Waiting for health check..."
          sleep 5

          for i in 1 2 3 4 5; do
            if curl -sf http://localhost:9101/health; then
              echo ""
              echo "‚úÖ Health check passed!"
              break
            fi
            echo "Retry $i/5..."
            sleep 2
          done

          # Verify version
          DEPLOYED_VERSION=$(curl -sf http://localhost:9101/health | jq -r '.version')
          if [ "$DEPLOYED_VERSION" = "$VERSION" ]; then
            echo "‚úÖ Version verified: $DEPLOYED_VERSION"
          else
            echo "‚ö†Ô∏è Version mismatch: expected $VERSION, got $DEPLOYED_VERSION"
          fi

          echo "‚úÖ Deployment complete!"

      - name: Verify external access
        run: |
          sleep 5
          curl -sf https://api.codeb.kr/health && echo "‚úÖ External access OK" || echo "‚ö†Ô∏è External access check failed"
