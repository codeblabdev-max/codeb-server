# CLAUDE.md - CodeB Server Project Rules

## Critical Rules

### 1. NEVER Run Dangerous Commands Directly

```bash
# 절대 금지 (Hooks가 차단함)
podman rm -f <container>       # 직접 컨테이너 삭제
podman volume rm <volume>      # 직접 볼륨 삭제
docker-compose down -v         # 볼륨 포함 삭제
rm -rf /opt/codeb/projects/*   # 프로젝트 폴더 삭제
```

### 2. ALWAYS Use CLI Commands

```bash
# 올바른 방법
we workflow init <project>     # 프로젝트 초기화
we deploy <project>            # 배포
we workflow stop <project>     # 서비스 중지
we workflow scan <project>     # 상태 확인
we ssot sync                   # 서버 데이터 동기화
we setup                       # 통합 설치 (규칙/MCP/Hooks)
```

### 3. SSH Only to Allowed Servers

허용된 서버만 SSH 접속 가능:
- 141.164.60.51 (CodeB Infra - PowerDNS + Caddy)
- 158.247.203.55 (Videopick App)
- 141.164.42.213 (Videopick Streaming)
- 64.176.226.119 (Videopick Storage)
- 141.164.37.63 (Videopick Backup)

### 4. Environment File Protection (MANDATORY)

**NEVER overwrite existing .env files without explicit user permission.**

When running `/we:init`, `we workflow init`, or any initialization command:

1. **Check for existing .env files FIRST**
   - `.env`, `.env.local`, `.env.development`, `.env.production`

2. **If .env files exist:**
   - Show current values to user
   - Ask for confirmation before ANY modification
   - Create `.env.backup.{timestamp}` before changes
   - MERGE new variables, don't replace entire file
   - NEVER change existing DATABASE_URL, REDIS_URL without explicit confirmation

3. **Protected Variables (require explicit confirmation):**
   - DATABASE_URL, REDIS_URL, DIRECT_URL, POSTGRES_*, DB_*

### 5. Port Assignment Rules

- Always scan server ports BEFORE assigning
- Use GitOps port ranges:
  - Staging: 3000-3499 (app), 15432-15499 (db), 16379-16399 (redis)
  - Production: 4000-4499 (app), 25432-25499 (db), 26379-26399 (redis)
  - Preview: 5000-5999 (app)

---

## Infrastructure Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CodeB Infrastructure                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  141.164.60.51 (CodeB Infra)                                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   PowerDNS      │  │     Caddy       │  │   MCP Server    │             │
│  │  (네임서버)      │  │ (리버스 프록시)  │  │  (배포 관리)     │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                              │                                              │
│              ┌───────────────┼───────────────┬───────────────┐             │
│              ▼               ▼               ▼               ▼             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌───────────┐│
│  │ 158.247.203.55  │ │ 141.164.42.213  │ │ 64.176.226.119  │ │141.164.37.││
│  │ Videopick App   │ │ Streaming       │ │ Storage         │ │  Backup   ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ └───────────┘│
└─────────────────────────────────────────────────────────────────────────────┘

배포 흐름: Git Push → GitHub Actions (build/test) → GHCR push → 서버 pull/restart
```

---

## Permission Model

| 역할 | SSH | Deploy | Server Settings | SSOT |
|------|-----|--------|-----------------|------|
| **Admin** | ✅ | ✅ 직접 | ✅ | 전체 권한 |
| **Developer** | ❌ | Git Push → 자동 | ❌ | 읽기 전용 |

---

## Project Structure

```
codeb-server/
├── cli/                    # /we CLI tool
├── codeb-deploy-system/    # MCP server for deployments
├── infrastructure/         # Terraform configs
├── docs/                   # Documentation
└── scripts/                # Utility scripts
```

## Quick Reference

```bash
# 통합 설치
we setup                       # 현재 프로젝트에 규칙/MCP/Hooks 설치
we setup --path /path/to/project  # 특정 경로에 설치

# 프로젝트 관리
we workflow init <project>     # Initialize new project
we workflow sync <project>     # Sync files to server
we workflow scan <project>     # Scan project status
we deploy <project>            # Deploy project

# SSOT (Single Source of Truth)
we ssot status                 # Check SSOT status
we ssot sync                   # Sync from server
we ssot projects               # List all projects

# 도메인 설정
we domain setup myapp.codeb.dev --ssl
```
