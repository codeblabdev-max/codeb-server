# CodeB HTTP API Guide

Developerìš© HTTP API Gateway ê°€ì´ë“œì…ë‹ˆë‹¤.

## ê°œìš”

CodeB HTTP API GatewayëŠ” SSH ì ‘ê·¼ ê¶Œí•œì´ ì—†ëŠ” Developerë„ `we deploy` ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” HTTP ê¸°ë°˜ API ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.

### ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CodeB Infrastructure                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Developer (SSH ì—†ìŒ)              Admin (SSH ìˆìŒ)             â”‚
â”‚        â”‚                               â”‚                         â”‚
â”‚        â–¼                               â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ we-cli   â”‚                   â”‚ we-cli   â”‚                   â”‚
â”‚   â”‚(HTTP API)â”‚                   â”‚(MCP/SSH) â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚        â”‚                               â”‚                         â”‚
â”‚        â”‚ HTTP (Port 9100)              â”‚ SSH                     â”‚
â”‚        â–¼                               â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚           CodeB Infra (141.164.60.51)                  â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚   â”‚  â”‚  HTTP API Gateway   â”‚  â”‚   MCP Server (Stdio) â”‚     â”‚    â”‚
â”‚   â”‚  â”‚   (Port 9100)       â”‚  â”‚                      â”‚     â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚   â”‚             â”‚                                           â”‚    â”‚
â”‚   â”‚             â”‚ MCP Tools                                 â”‚    â”‚
â”‚   â”‚             â–¼                                           â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚   â”‚  â”‚              MCP Tool Handlers                    â”‚  â”‚    â”‚
â”‚   â”‚  â”‚  (deploy, healthcheck, ssot, domain, etc.)       â”‚  â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚   â”‚                          â”‚                             â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â”‚ SSH                               â”‚
â”‚                              â–¼                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚          Other Servers (SSH controlled)                    â”‚â”‚
â”‚   â”‚  â€¢ Videopick App (158.247.203.55)                          â”‚â”‚
â”‚   â”‚  â€¢ Videopick Streaming (141.164.42.213)                    â”‚â”‚
â”‚   â”‚  â€¢ Videopick Storage (64.176.226.119)                      â”‚â”‚
â”‚   â”‚  â€¢ Videopick Backup (141.164.37.63)                        â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Developer ì„¤ì •

### 1. we-cli ì„¤ì¹˜

```bash
cd /path/to/codeb-server/cli
npm install
npm link
```

### 2. API í‚¤ ì„¤ì •

Adminì—ê²Œ API í‚¤ë¥¼ ìš”ì²­í•œ í›„, ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì˜ ë°©ë²•ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

**ë°©ë²• A: í™˜ê²½ ë³€ìˆ˜**
```bash
export CODEB_API_KEY="your-api-key"
export CODEB_SERVER_HOST="141.164.60.51"
```

**ë°©ë²• B: ì„¤ì • íŒŒì¼ (~/.codeb/config.json)**
```json
{
  "CODEB_SERVER_HOST": "141.164.60.51",
  "CODEB_API_KEY": "your-api-key",
  "CODEB_DOMAIN": "one-q.xyz"
}
```

### 3. ì—°ê²° í™•ì¸

```bash
we health
```

HTTP API ëª¨ë“œë¡œ ì—°ê²°ë˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ í‘œì‹œë©ë‹ˆë‹¤:
```
ğŸŒ HTTP API MODE
Using HTTP API for deployment (no SSH required)
```

## Admin ì„¤ì • (HTTP API ì„œë²„ ë°°í¬)

### 1. HTTP API ì„œë²„ ë¹Œë“œ ë° ë°°í¬

```bash
cd codeb-deploy-system/mcp-server
./deploy-http-api.sh [API_KEY]
```

API í‚¤ê°€ ì œê³µë˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.

### 2. ìˆ˜ë™ ë°°í¬

```bash
# ë¹Œë“œ
npm run build

# íŒŒì¼ ë³µì‚¬
scp dist/http-api.js root@141.164.60.51:/opt/codeb/mcp-server/dist/
scp codeb-http-api.service root@141.164.60.51:/etc/systemd/system/

# ì„œë¹„ìŠ¤ ì‹œì‘
ssh root@141.164.60.51 << 'EOF'
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
cat > /opt/codeb/mcp-server/.env << 'ENVEOF'
NODE_ENV=production
CODEB_HTTP_API_PORT=9100
CODEB_API_KEY=your-secure-api-key
ENVEOF

# ì„œë¹„ìŠ¤ ì‹œì‘
systemctl daemon-reload
systemctl enable codeb-http-api
systemctl restart codeb-http-api
EOF
```

### 3. API í‚¤ ê´€ë¦¬

API í‚¤ëŠ” `/opt/codeb/mcp-server/.env` íŒŒì¼ì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤:

```bash
# ìƒˆ API í‚¤ ìƒì„±
NEW_KEY=$(openssl rand -hex 32)
echo "CODEB_API_KEY=$NEW_KEY" >> /opt/codeb/mcp-server/.env
systemctl restart codeb-http-api
```

## API ì—”ë“œí¬ì¸íŠ¸

### Health Check (ì¸ì¦ ë¶ˆí•„ìš”)

```bash
curl http://141.164.60.51:9100/health
```

ì‘ë‹µ:
```json
{
  "status": "healthy",
  "service": "codeb-deploy-http-api",
  "version": "1.0.0",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ëª©ë¡

```bash
curl -H "X-API-Key: your-api-key" \
  http://141.164.60.51:9100/api/tools
```

### ë„êµ¬ ì‹¤í–‰

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{"tool": "ssot_get", "params": {}}' \
  http://141.164.60.51:9100/api/tool
```

ì‘ë‹µ:
```json
{
  "success": true,
  "tool": "ssot_get",
  "result": { ... },
  "duration": "123ms",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### ì„œë²„ ì •ë³´

```bash
curl -H "X-API-Key: your-api-key" \
  http://141.164.60.51:9100/api/info
```

## we-cli ëª…ë ¹ì–´ (Developerìš©)

DeveloperëŠ” HTTP APIë¥¼ í†µí•´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```bash
# í”„ë¡œì íŠ¸ ì´ˆê¸°í™” (ë¡œì»¬ íŒŒì¼ ìƒì„±)
we workflow init my-project

# í”„ë¡œì íŠ¸ ë°°í¬
we deploy my-project --env staging

# í—¬ìŠ¤ì²´í¬
we health my-project --env staging

# í”„ë¡œì íŠ¸ ëª©ë¡
we ssot list

# í¬íŠ¸ í™•ì¸
we ssot port-summary
```

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **API í‚¤ ë³´ì•ˆ**: API í‚¤ëŠ” ì¶©ë¶„íˆ ê¸´ ëœë¤ ë¬¸ìì—´ì„ ì‚¬ìš©í•˜ì„¸ìš” (ìµœì†Œ 32ì).

2. **HTTPS**: í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” Caddyë¥¼ í†µí•´ HTTPSë¥¼ ì ìš©í•˜ì„¸ìš”.
   ```
   api.codeb.dev {
     reverse_proxy localhost:9100
   }
   ```

3. **IP ì œí•œ**: í•„ìš”ì‹œ ë°©í™”ë²½ì—ì„œ í—ˆìš©ëœ IPë§Œ ì ‘ê·¼í•˜ë„ë¡ ì œí•œí•˜ì„¸ìš”.

4. **ë¡œê¹…**: ëª¨ë“  API í˜¸ì¶œì€ journaldì— ê¸°ë¡ë©ë‹ˆë‹¤.
   ```bash
   journalctl -u codeb-http-api -f
   ```

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì—°ê²° ì‹¤íŒ¨

```
Error: HTTP API failed: fetch failed
```

ì›ì¸: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŒ
í•´ê²°:
1. ì„œë²„ ìƒíƒœ í™•ì¸: `ssh root@141.164.60.51 "systemctl status codeb-http-api"`
2. ë°©í™”ë²½ í™•ì¸: í¬íŠ¸ 9100ì´ ì—´ë ¤ ìˆëŠ”ì§€ í™•ì¸
3. ë„¤íŠ¸ì›Œí¬ í™•ì¸: `curl -v http://141.164.60.51:9100/health`

### ì¸ì¦ ì‹¤íŒ¨

```
Error: Unauthorized: Invalid or missing API key
```

ì›ì¸: API í‚¤ê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ëˆ„ë½ë¨
í•´ê²°:
1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸: `echo $CODEB_API_KEY`
2. ì„¤ì • íŒŒì¼ í™•ì¸: `cat ~/.codeb/config.json`
3. Adminì—ê²Œ ì˜¬ë°”ë¥¸ API í‚¤ ìš”ì²­

### ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨

```
Error: Unknown tool: invalid_tool_name
```

ì›ì¸: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë„êµ¬ í˜¸ì¶œ
í•´ê²°: `/api/tools` ì—”ë“œí¬ì¸íŠ¸ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ëª©ë¡ í™•ì¸

## ê´€ë ¨ íŒŒì¼

- `codeb-deploy-system/mcp-server/src/http-api.ts`: HTTP API Gateway ì†ŒìŠ¤
- `codeb-deploy-system/mcp-server/codeb-http-api.service`: systemd ì„œë¹„ìŠ¤ íŒŒì¼
- `codeb-deploy-system/mcp-server/deploy-http-api.sh`: ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
- `cli/src/lib/mcp-client.js`: CLI HTTP API í´ë¼ì´ì–¸íŠ¸
