---
# CodeB Backup Playbook
#
# ë°ì´í„°ë² ì´ìŠ¤ ë° ì„¤ì • ë°±ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
#
# ì‹¤í–‰:
#   ansible-playbook -i inventory.yml playbooks/backup.yml
#
# Cron ì„¤ì •:
#   0 2 * * * ansible-playbook -i /path/to/inventory.yml /path/to/playbooks/backup.yml

- name: CodeB Backup
  hosts: codeb
  become: yes
  gather_facts: yes

  vars:
    backup_dir: /opt/codeb/backup
    backup_retention_days: 7
    postgres_container: codeb-postgres
    postgres_db: codeb
    postgres_user: codeb

  tasks:
    # =========================================================
    # ì¤€ë¹„
    # =========================================================
    - name: Set backup timestamp
      set_fact:
        backup_timestamp: "{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}"

    - name: Create backup directory
      file:
        path: "{{ backup_dir }}/{{ backup_timestamp }}"
        state: directory
        mode: '0700'

    # =========================================================
    # PostgreSQL ë°±ì—…
    # =========================================================
    - name: Check if PostgreSQL container is running
      command: podman inspect {{ postgres_container }} --format '{{ '{{' }}.State.Running{{ '}}' }}'
      register: postgres_running
      changed_when: false
      failed_when: false

    - name: Backup PostgreSQL database
      shell: |
        podman exec {{ postgres_container }} pg_dump -U {{ postgres_user }} {{ postgres_db }} | gzip > {{ backup_dir }}/{{ backup_timestamp }}/postgres_{{ postgres_db }}.sql.gz
      when: postgres_running.stdout == "true"
      register: postgres_backup

    - name: Display PostgreSQL backup result
      debug:
        msg: "PostgreSQL ë°±ì—…: {{ 'success' if postgres_backup.rc == 0 else 'failed' }}"
      when: postgres_running.stdout == "true"

    # =========================================================
    # Redis ë°±ì—… (ì„ íƒì )
    # =========================================================
    - name: Check if Redis container is running
      command: podman inspect codeb-redis --format '{{ '{{' }}.State.Running{{ '}}' }}'
      register: redis_running
      changed_when: false
      failed_when: false

    - name: Backup Redis data
      shell: |
        podman exec codeb-redis redis-cli BGSAVE
        sleep 5
        cp /opt/codeb/data/redis/dump.rdb {{ backup_dir }}/{{ backup_timestamp }}/redis_dump.rdb 2>/dev/null || true
      when: redis_running.stdout == "true"
      failed_when: false

    # =========================================================
    # ì„¤ì • íŒŒì¼ ë°±ì—…
    # =========================================================
    - name: Backup configuration files
      archive:
        path:
          - /opt/codeb/config
          - /etc/caddy/Caddyfile
        dest: "{{ backup_dir }}/{{ backup_timestamp }}/config_backup.tar.gz"
        format: gz
      failed_when: false

    # =========================================================
    # ë°±ì—… ê²€ì¦
    # =========================================================
    - name: List backup files
      find:
        paths: "{{ backup_dir }}/{{ backup_timestamp }}"
        file_type: file
      register: backup_files

    - name: Display backup summary
      debug:
        msg: |
          ğŸ“¦ ë°±ì—… ì™„ë£Œ: {{ backup_timestamp }}

          ë°±ì—… íŒŒì¼:
          {% for file in backup_files.files %}
          - {{ file.path | basename }} ({{ (file.size / 1024 / 1024) | round(2) }} MB)
          {% endfor %}

          ìœ„ì¹˜: {{ backup_dir }}/{{ backup_timestamp }}

    # =========================================================
    # ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬
    # =========================================================
    - name: Find old backups
      find:
        paths: "{{ backup_dir }}"
        file_type: directory
        age: "{{ backup_retention_days }}d"
      register: old_backups

    - name: Remove old backups
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"
      when: old_backups.files | length > 0

    - name: Display cleanup result
      debug:
        msg: "ğŸ§¹ {{ old_backups.files | length }}ê°œì˜ ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œë¨"
      when: old_backups.files | length > 0

    # =========================================================
    # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
    # =========================================================
    - name: Check backup disk usage
      shell: du -sh {{ backup_dir }}
      register: disk_usage
      changed_when: false

    - name: Display disk usage
      debug:
        msg: "ğŸ’¾ ë°±ì—… ì´ ìš©ëŸ‰: {{ disk_usage.stdout.split()[0] }}"
