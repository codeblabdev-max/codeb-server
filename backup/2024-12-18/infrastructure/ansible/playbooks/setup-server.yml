---
# CodeB Server Setup Playbook
#
# 새 서버 초기 설정을 자동화합니다.
#
# 실행:
#   ansible-playbook -i inventory.yml playbooks/setup-server.yml

- name: CodeB Server Initial Setup
  hosts: codeb
  become: yes
  gather_facts: yes

  vars:
    project_name: codeb
    node_version: "20"
    timezone: "Asia/Seoul"
    swap_size: "2G"

  handlers:
    - name: restart sshd
      service:
        name: sshd
        state: restarted

    - name: restart caddy
      service:
        name: caddy
        state: restarted

  tasks:
    # =========================================================
    # 시스템 업데이트
    # =========================================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes

    # =========================================================
    # 필수 패키지 설치
    # =========================================================
    - name: Install essential packages
      apt:
        name:
          - curl
          - wget
          - git
          - htop
          - vim
          - unzip
          - ca-certificates
          - gnupg
          - lsb-release
          - jq
          - tree
          - ufw
          - fail2ban
          - unattended-upgrades
        state: present

    # =========================================================
    # Podman 설치
    # =========================================================
    - name: Install Podman
      apt:
        name: podman
        state: present

    - name: Verify Podman installation
      command: podman --version
      register: podman_version
      changed_when: false

    - name: Display Podman version
      debug:
        msg: "Podman {{ podman_version.stdout }}"

    # =========================================================
    # Node.js 설치
    # =========================================================
    - name: Add NodeSource repository key
      apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        state: present

    - name: Add NodeSource repository
      apt_repository:
        repo: "deb https://deb.nodesource.com/node_{{ node_version }}.x {{ ansible_distribution_release }} main"
        state: present
        filename: nodesource

    - name: Install Node.js
      apt:
        name: nodejs
        state: present
        update_cache: yes

    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes
        state: present

    # =========================================================
    # Caddy 설치
    # =========================================================
    - name: Add Caddy apt key
      apt_key:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        state: present

    - name: Add Caddy repository
      apt_repository:
        repo: "deb https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
        state: present
        filename: caddy-stable

    - name: Install Caddy
      apt:
        name: caddy
        state: present
        update_cache: yes

    # =========================================================
    # GitHub CLI 설치
    # =========================================================
    - name: Add GitHub CLI apt key
      apt_key:
        url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
        keyring: /usr/share/keyrings/githubcli-archive-keyring.gpg
        state: present

    - name: Add GitHub CLI repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        state: present
        filename: github-cli

    - name: Install GitHub CLI
      apt:
        name: gh
        state: present
        update_cache: yes

    # =========================================================
    # 디렉토리 구조 생성
    # =========================================================
    - name: Create CodeB directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/codeb/config
        - /opt/codeb/data/app
        - /opt/codeb/data/postgres
        - /opt/codeb/data/redis
        - /opt/codeb/logs/app
        - /opt/codeb/logs/caddy
        - /opt/codeb/backup
        - /opt/codeb/scripts

    # =========================================================
    # Podman 네트워크 생성
    # =========================================================
    - name: Create Podman network
      command: podman network create codeb-network
      register: network_result
      changed_when: network_result.rc == 0
      failed_when: false

    # =========================================================
    # 방화벽 설정
    # =========================================================
    - name: Reset UFW
      ufw:
        state: reset

    - name: Set UFW default policies
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }

    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
        comment: 'SSH'

    - name: Allow HTTP
      ufw:
        rule: allow
        port: '80'
        proto: tcp
        comment: 'HTTP'

    - name: Allow HTTPS
      ufw:
        rule: allow
        port: '443'
        proto: tcp
        comment: 'HTTPS'

    - name: Enable UFW
      ufw:
        state: enabled

    # =========================================================
    # Swap 설정
    # =========================================================
    - name: Check if swap file exists
      stat:
        path: /swapfile
      register: swap_file

    - name: Create swap file
      command: fallocate -l {{ swap_size }} /swapfile
      when: not swap_file.stat.exists

    - name: Set swap file permissions
      file:
        path: /swapfile
        mode: '0600'
      when: not swap_file.stat.exists

    - name: Make swap file
      command: mkswap /swapfile
      when: not swap_file.stat.exists

    - name: Enable swap
      command: swapon /swapfile
      when: not swap_file.stat.exists

    - name: Add swap to fstab
      lineinfile:
        path: /etc/fstab
        line: '/swapfile none swap sw 0 0'
        state: present

    - name: Set swappiness
      sysctl:
        name: vm.swappiness
        value: '10'
        state: present
        reload: yes

    # =========================================================
    # 타임존 설정
    # =========================================================
    - name: Set timezone
      timezone:
        name: "{{ timezone }}"

    # =========================================================
    # SSH 보안 설정
    # =========================================================
    - name: Disable password authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
      notify: restart sshd

    - name: Disable root password login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin prohibit-password'
      notify: restart sshd

    # =========================================================
    # 자동 보안 업데이트
    # =========================================================
    - name: Enable automatic security updates
      copy:
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";
          APT::Periodic::AutocleanInterval "7";
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        mode: '0644'

    # =========================================================
    # 완료 메시지
    # =========================================================
    - name: Display completion message
      debug:
        msg: |
          ✅ CodeB 서버 설정 완료!

          설치된 도구:
          - Podman: {{ podman_version.stdout }}
          - Node.js: {{ ansible_facts.packages['nodejs'][0].version | default('설치됨') }}
          - Caddy: 설치됨
          - GitHub CLI: 설치됨

          다음 단계:
          1. Caddy 설정: /etc/caddy/Caddyfile
          2. 환경변수: /opt/codeb/config/
          3. 배포 테스트
