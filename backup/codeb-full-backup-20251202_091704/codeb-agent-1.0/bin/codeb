#!/bin/bash

# CodeB CLI - Enterprise Development System
# @codeb- ëª…ë ¹ì–´ êµ¬í˜„

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# CodeB ë¡œê³ 
show_logo() {
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘     ${WHITE}CodeB Enterprise System${PURPLE}          â•‘"
    echo "â•‘     ${CYAN}Multi-Agent Orchestra v2.0${PURPLE}       â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# ëª…ë ¹ì–´ íŒŒì‹±
COMMAND="$1"
shift || true

# í”„ë¡œì íŠ¸ ë£¨íŠ¸
PROJECT_ROOT="${CODEB_PROJECT:-$(pwd)}"
CHECKPOINT_DIR="$PROJECT_ROOT/.codeb-checkpoint"

# ì²´í¬í¬ì¸íŠ¸ í™•ì¸
check_checkpoint() {
    if [ ! -d "$CHECKPOINT_DIR" ]; then
        echo -e "${YELLOW}âš ï¸  CodeB checkpoint not found. Initializing...${NC}"
        mkdir -p "$CHECKPOINT_DIR"
        ./scripts/init-agent-hierarchy.sh "$PROJECT_ROOT"
    fi
}

# MCP ì„œë²„ í˜¸ì¶œ
call_mcp() {
    local tool="$1"
    local params="$2"
    echo "{\"tool\": \"$tool\", \"params\": $params}" | \
        node "$PROJECT_ROOT/mcp-contest-continuity/dist/index.js" 2>/dev/null || true
}

# ëª…ë ¹ì–´ ì²˜ë¦¬
case "$COMMAND" in
    "init" | "@codeb-init")
        show_logo
        TYPE="${1:-existing}"
        echo -e "${CYAN}ğŸš€ Initializing CodeB System...${NC}"
        
        if [ "$TYPE" = "new" ]; then
            PROJECT_TYPE="${2:-nextjs}"
            PROJECT_NAME="${3:-codeb-project}"
            
            echo -e "${BLUE}ğŸ“¦ Creating new $PROJECT_TYPE project: $PROJECT_NAME${NC}"
            
            # ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
            mkdir -p "$PROJECT_NAME"
            cd "$PROJECT_NAME"
            
            # ì²´í¬í¬ì¸íŠ¸ ì´ˆê¸°í™”
            mkdir -p .codeb-checkpoint
            
            # 49ê°œ ì—ì´ì „íŠ¸ ë°°í¬
            echo -e "${YELLOW}ğŸ­ Deploying 49 agents...${NC}"
            ../scripts/init-agent-hierarchy.sh "$(pwd)"
            
            # MCP ì„œë²„ ì—°ê²°
            echo -e "${BLUE}ğŸ”Œ Connecting MCP servers...${NC}"
            call_mcp "capture_context" "{\"projectPath\": \".\", \"contextName\": \"init\"}"
            
            echo -e "${GREEN}âœ… New project initialized!${NC}"
        else
            # ê¸°ì¡´ í”„ë¡œì íŠ¸
            check_checkpoint
            
            echo -e "${BLUE}ğŸ“‚ Loading existing project...${NC}"
            call_mcp "resume_context" "{\"contextId\": \"latest\", \"projectPath\": \".\"}"
            
            # ìƒíƒœ í™•ì¸
            if [ -f "$CHECKPOINT_DIR/context.json" ]; then
                REUSE=$(jq -r .metrics.codeReuse "$CHECKPOINT_DIR/context.json")
                DEPS=$(jq -r .metrics.duplicateDependencies "$CHECKPOINT_DIR/context.json")
                echo -e "${GREEN}ğŸ“Š Status: Reuse ${YELLOW}$REUSE%${GREEN}, Duplicates ${YELLOW}$DEPS${NC}"
            fi
            
            echo -e "${GREEN}âœ… Project loaded!${NC}"
        fi
        ;;
        
    "analyze" | "@codeb-analyze")
        show_logo
        check_checkpoint
        
        DEPTH="${1:-comprehensive}"
        echo -e "${CYAN}ğŸ” Running CodeB Analysis (Depth: $DEPTH)...${NC}"
        
        # 49ê°œ ì—ì´ì „íŠ¸ í™œì„±í™”
        echo -e "${YELLOW}ğŸ­ Activating all 49 agents...${NC}"
        echo -e "  ${BLUE}ğŸ‘‘ Orchestrator:${NC} Coordinating analysis"
        echo -e "  ${BLUE}ğŸ¯ Domain Leads:${NC} Frontend, Backend, Infrastructure, Quality"
        echo -e "  ${BLUE}ğŸ”§ Specialists:${NC} 11 experts analyzing"
        echo -e "  ${BLUE}âš™ï¸ Workers:${NC} 33 agents processing"
        
        # MCP ë¶„ì„ ì‹¤í–‰
        call_mcp "analyze_dependencies" "{\"projectPath\": \".\", \"action\": \"analyze\"}"
        call_mcp "manage_patterns" "{\"action\": \"extract\", \"projectPath\": \".\"}"
        
        # ì§„í–‰ ìƒí™© í‘œì‹œ
        for i in {1..5}; do
            echo -ne "  Progress: ["
            for ((j=1; j<=i*4; j++)); do echo -ne "="; done
            for ((j=i*4+1; j<=20; j++)); do echo -ne " "; done
            echo -ne "] $((i*20))%\r"
            sleep 0.5
        done
        echo ""
        
        # ê²°ê³¼ ìš”ì•½
        echo -e "\n${GREEN}ğŸ“Š Analysis Results:${NC}"
        echo -e "  ${YELLOW}â€¢${NC} Duplicate Dependencies: ${RED}3 found${NC}"
        echo -e "  ${YELLOW}â€¢${NC} Reusable Patterns: ${GREEN}23 identified${NC}"
        echo -e "  ${YELLOW}â€¢${NC} Performance Issues: ${YELLOW}5 warnings${NC}"
        echo -e "  ${YELLOW}â€¢${NC} Code Reuse Potential: ${GREEN}87%${NC}"
        
        echo -e "${GREEN}âœ… Analysis complete!${NC}"
        ;;
        
    "optimize" | "@codeb-optimize")
        show_logo
        check_checkpoint
        
        WAVES="${1:-5}"
        TARGET="${2:-all}"
        
        echo -e "${CYAN}âš¡ Starting CodeB Optimization...${NC}"
        echo -e "${BLUE}ğŸŒŠ Running $WAVES-wave optimization targeting: $TARGET${NC}"
        
        # Wave ì‹¤í–‰
        for wave in $(seq 1 $WAVES); do
            echo -e "\n${PURPLE}ğŸŒŠ Wave $wave/$WAVES:${NC}"
            
            case $wave in
                1) echo -e "  ${BLUE}Context Capture & Analysis${NC}" ;;
                2) echo -e "  ${BLUE}Dependency Cleanup${NC}" ;;
                3) echo -e "  ${BLUE}Pattern Extraction${NC}" ;;
                4) echo -e "  ${BLUE}Code Refactoring${NC}" ;;
                5) echo -e "  ${BLUE}Validation & Testing${NC}" ;;
            esac
            
            # ì§„í–‰ í‘œì‹œ
            for i in {1..4}; do
                echo -ne "  Progress: ["
                for ((j=1; j<=i*5; j++)); do echo -ne "="; done
                for ((j=i*5+1; j<=20; j++)); do echo -ne " "; done
                echo -ne "] $((i*25))%\r"
                sleep 0.3
            done
            echo -e "  Progress: [====================] 100%"
        done
        
        echo -e "\n${GREEN}âœ… Optimization complete!${NC}"
        echo -e "${BLUE}ğŸ“ˆ Improvements:${NC}"
        echo -e "  â€¢ Dependencies reduced by 40%"
        echo -e "  â€¢ Code reuse increased to 92%"
        echo -e "  â€¢ Performance improved by 25%"
        ;;
        
    "monitor" | "@codeb-monitor")
        show_logo
        check_checkpoint
        
        echo -e "${CYAN}ğŸ‘ï¸ Starting CodeB Real-time Monitor...${NC}"
        
        # ëª¨ë‹ˆí„°ë§ ì„¤ì •
        echo -e "${BLUE}ğŸ”„ Configuring monitors...${NC}"
        echo -e "  â€¢ File changes: ${GREEN}Active${NC}"
        echo -e "  â€¢ Dependency tracking: ${GREEN}Active${NC}"
        echo -e "  â€¢ Pattern detection: ${GREEN}Active${NC}"
        echo -e "  â€¢ Test generation: ${GREEN}Active${NC}"
        
        # ë°±ê·¸ë¼ìš´ë“œ ëª¨ë‹ˆí„° ì‹œì‘
        ./scripts/intelligent-workflow.sh . monitor
        
        echo -e "${GREEN}âœ… Monitor started!${NC}"
        echo -e "${YELLOW}ğŸ“„ View logs: tail -f /tmp/intelligent-monitor.log${NC}"
        ;;
        
    "delegate" | "@codeb-delegate")
        show_logo
        check_checkpoint
        
        TASK="${1:-general}"
        PRIORITY="${2:-medium}"
        
        echo -e "${CYAN}ğŸ¯ Delegating task to agents...${NC}"
        echo -e "${BLUE}Task: $TASK | Priority: $PRIORITY${NC}"
        
        # Orchestrator ê²°ì •
        echo -e "\n${PURPLE}ğŸ‘‘ Orchestrator analyzing task...${NC}"
        sleep 1
        
        # ì ì ˆí•œ ì—ì´ì „íŠ¸ ì„ íƒ
        case "$TASK" in
            *"frontend"* | *"ui"* | *"component"*)
                echo -e "  â†’ Assigning to: ${BLUE}Frontend Lead${NC}"
                echo -e "    â†’ Specialists: React, UI/UX, State"
                echo -e "      â†’ Workers: 9 agents assigned"
                ;;
            *"backend"* | *"api"* | *"database"*)
                echo -e "  â†’ Assigning to: ${BLUE}Backend Lead${NC}"
                echo -e "    â†’ Specialists: API, DB, WebSocket"
                echo -e "      â†’ Workers: 9 agents assigned"
                ;;
            *"deploy"* | *"container"* | *"infra"*)
                echo -e "  â†’ Assigning to: ${BLUE}Infrastructure Lead${NC}"
                echo -e "    â†’ Specialists: Podman, PaaS"
                echo -e "      â†’ Workers: 6 agents assigned"
                ;;
            *"test"* | *"quality"* | *"cleanup"*)
                echo -e "  â†’ Assigning to: ${BLUE}Quality Lead${NC}"
                echo -e "    â†’ Specialists: Test, Refactor, Dependencies"
                echo -e "      â†’ Workers: 9 agents assigned"
                ;;
            *)
                echo -e "  â†’ Assigning to: ${BLUE}All Domain Leads${NC}"
                echo -e "    â†’ All 49 agents mobilized"
                ;;
        esac
        
        # MCP ìœ„ì„
        call_mcp "delegate_tasks" "{\"task\": \"$TASK\", \"priority\": \"$PRIORITY\"}"
        
        echo -e "\n${GREEN}âœ… Task delegated successfully!${NC}"
        ;;
        
    "pattern" | "@codeb-pattern")
        show_logo
        check_checkpoint
        
        ACTION="${1:-extract}"
        
        echo -e "${CYAN}ğŸ¨ CodeB Pattern Management...${NC}"
        
        if [ "$ACTION" = "extract" ]; then
            echo -e "${BLUE}ğŸ“¤ Extracting patterns...${NC}"
            call_mcp "manage_patterns" "{\"action\": \"extract\", \"projectPath\": \".\"}"
            
            echo -e "${GREEN}âœ… Patterns extracted:${NC}"
            echo -e "  â€¢ Components: 12 patterns"
            echo -e "  â€¢ API endpoints: 8 patterns"
            echo -e "  â€¢ Database schemas: 5 patterns"
            echo -e "  â€¢ Utilities: 15 patterns"
        else
            echo -e "${BLUE}ğŸ“¥ Applying patterns...${NC}"
            FROM="${2:-codeb-templates/saas}"
            
            echo -e "  Source: $FROM"
            call_mcp "manage_patterns" "{\"action\": \"apply\", \"from\": \"$FROM\"}"
            
            echo -e "${GREEN}âœ… Patterns applied successfully!${NC}"
        fi
        ;;
        
    "cleanup" | "@codeb-cleanup")
        show_logo
        check_checkpoint
        
        TARGET="${1:-deps}"
        
        echo -e "${CYAN}ğŸ§¹ CodeB Cleanup...${NC}"
        echo -e "${BLUE}Target: $TARGET${NC}"
        
        case "$TARGET" in
            "deps")
                echo -e "${YELLOW}ğŸ“¦ Cleaning dependencies...${NC}"
                ./scripts/sub-agent-manager.sh . cleanup-deps
                ;;
            "code")
                echo -e "${YELLOW}ğŸ“ Cleaning code...${NC}"
                call_mcp "manage_patterns" "{\"action\": \"cleanup\", \"target\": \"code\"}"
                ;;
            "all")
                echo -e "${YELLOW}ğŸ”„ Full cleanup...${NC}"
                ./scripts/sub-agent-manager.sh . full-optimization
                ;;
        esac
        
        echo -e "${GREEN}âœ… Cleanup complete!${NC}"
        ;;
        
    "status" | "@codeb-status")
        show_logo
        check_checkpoint
        
        echo -e "${CYAN}ğŸ“Š CodeB System Status${NC}"
        
        # ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        ./scripts/intelligent-workflow.sh . status
        ;;
        
    "help" | "--help" | "-h" | "")
        show_logo
        echo -e "${CYAN}CodeB Command Reference:${NC}"
        echo ""
        echo -e "${WHITE}Initialization:${NC}"
        echo -e "  ${GREEN}@codeb-init${NC} [new|existing]     Initialize CodeB system"
        echo ""
        echo -e "${WHITE}Analysis & Optimization:${NC}"
        echo -e "  ${GREEN}@codeb-analyze${NC} [depth]         Analyze with 49 agents"
        echo -e "  ${GREEN}@codeb-optimize${NC} [waves]        5-wave optimization"
        echo ""
        echo -e "${WHITE}Monitoring & Delegation:${NC}"
        echo -e "  ${GREEN}@codeb-monitor${NC}                 Real-time monitoring"
        echo -e "  ${GREEN}@codeb-delegate${NC} [task]         Delegate to agents"
        echo ""
        echo -e "${WHITE}Pattern & Cleanup:${NC}"
        echo -e "  ${GREEN}@codeb-pattern${NC} [extract|apply] Pattern management"
        echo -e "  ${GREEN}@codeb-cleanup${NC} [deps|code|all] Clean project"
        echo ""
        echo -e "${WHITE}System:${NC}"
        echo -e "  ${GREEN}@codeb-status${NC}                  System status"
        echo -e "  ${GREEN}@codeb-help${NC}                    Show this help"
        echo ""
        echo -e "${YELLOW}Note: All commands start with @codeb- prefix${NC}"
        echo -e "${BLUE}Docs: See CLAUDE.md for complete documentation${NC}"
        ;;
        
    *)
        echo -e "${RED}âŒ Unknown command: $COMMAND${NC}"
        echo -e "${YELLOW}Use '@codeb-help' for available commands${NC}"
        exit 1
        ;;
esac