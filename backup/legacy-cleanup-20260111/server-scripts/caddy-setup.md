# Caddy Setup for CodeB Domain Manager

## 1. Install Caddy (if not installed)

```bash
# Ubuntu/Debian
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
```

## 2. Main Caddyfile Configuration

**File:** `/etc/caddy/Caddyfile`

```caddy
# CodeB Main Caddyfile
# Auto-generated configurations are imported from sites/

{
  # Global options
  email admin@codeb.kr

  # ACME server (Let's Encrypt)
  acme_ca https://acme-v02.api.letsencrypt.org/directory

  # Admin API
  admin localhost:2019
}

# Import all site configurations
import sites/*.caddy

# Default fallback (optional)
:80 {
  respond "CodeB Server" 200
}
```

## 3. Create Sites Directory

```bash
sudo mkdir -p /etc/caddy/sites
sudo mkdir -p /var/log/caddy
sudo chown -R caddy:caddy /var/log/caddy
```

## 4. Example Site Configuration

**File:** `/etc/caddy/sites/example.codeb.kr.caddy`

```caddy
# example.codeb.kr - Auto-generated by CodeB Domain Manager
example.codeb.kr {
  # Reverse proxy to application
  reverse_proxy localhost:3000

  # Automatic HTTPS with Let's Encrypt
  tls {
    protocols tls1.2 tls1.3
  }

  # Gzip compression
  encode gzip

  # Security headers
  header {
    X-Frame-Options "SAMEORIGIN"
    X-Content-Type-Options "nosniff"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
  }

  # Access logs
  log {
    output file /var/log/caddy/example.codeb.kr.log {
      roll_size 10mb
      roll_keep 5
    }
  }
}
```

## 5. Test and Reload

```bash
# Test configuration
sudo caddy validate --config /etc/caddy/Caddyfile

# Reload Caddy
sudo systemctl reload caddy

# Check status
sudo systemctl status caddy

# View logs
sudo journalctl -u caddy -f
```

## 6. SSL Certificate Location

Caddy automatically stores SSL certificates in:

```
/var/lib/caddy/certificates/acme-v02.api.letsencrypt.org-directory/
```

Example:
```
/var/lib/caddy/certificates/acme-v02.api.letsencrypt.org-directory/example.codeb.kr/
  ├── example.codeb.kr.crt
  ├── example.codeb.kr.key
  └── example.codeb.kr.json
```

## 7. Common Issues

### Issue: Port 80/443 already in use

```bash
# Check what's using the ports
sudo lsof -i :80
sudo lsof -i :443

# Stop conflicting services
sudo systemctl stop nginx  # if nginx is installed
```

### Issue: Permission denied

```bash
# Allow Caddy to bind to privileged ports
sudo setcap 'cap_net_bind_service=+ep' /usr/bin/caddy
```

### Issue: DNS not resolving

```bash
# Check DNS propagation
dig example.codeb.kr

# Make sure PowerDNS is serving correctly
dig @158.247.203.55 example.codeb.kr
```

## 8. Advanced Configurations

### Custom Headers

```caddy
example.codeb.kr {
  reverse_proxy localhost:3000

  header {
    Custom-Header "value"
    -Server  # Remove Server header
  }
}
```

### Rate Limiting

```caddy
example.codeb.kr {
  reverse_proxy localhost:3000

  # Rate limit using Caddy plugin
  rate_limit {
    zone dynamic {
      key {remote_host}
      events 100
      window 1m
    }
  }
}
```

### WebSocket Support

```caddy
example.codeb.kr {
  reverse_proxy localhost:3000 {
    # WebSocket support
    transport http {
      versions h2c
    }
  }
}
```

### Multiple Backends (Load Balancing)

```caddy
example.codeb.kr {
  reverse_proxy localhost:3000 localhost:3001 localhost:3002 {
    lb_policy round_robin
    health_uri /health
    health_interval 10s
  }
}
```

## 9. Monitoring

### Check Active Certificates

```bash
# List all certificates
sudo ls -la /var/lib/caddy/certificates/acme-v02.api.letsencrypt.org-directory/

# Check certificate expiry
echo | openssl s_client -servername example.codeb.kr -connect example.codeb.kr:443 2>/dev/null | openssl x509 -noout -dates
```

### View Access Logs

```bash
# Tail specific domain logs
sudo tail -f /var/log/caddy/example.codeb.kr.log

# All Caddy logs
sudo journalctl -u caddy -f
```

## 10. Automation with Domain Manager

The Domain Manager automatically:

1. Creates site configuration in `/etc/caddy/sites/<domain>.caddy`
2. Validates configuration with `caddy validate`
3. Reloads Caddy with `systemctl reload caddy`
4. Monitors SSL certificate issuance

No manual intervention required!
