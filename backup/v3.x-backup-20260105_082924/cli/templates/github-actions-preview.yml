# CodeB CI/CD Pipeline - Image Promotion Strategy
# Generated by CodeB CLI
#
# ì „ëµ: ì´ë¯¸ì§€ í”„ë¡œëª¨ì…˜ (1ë²ˆ ë¹Œë“œ, í…ŒìŠ¤íŠ¸ëœ ì´ë¯¸ì§€ ê·¸ëŒ€ë¡œ Production ë°°í¬)
#
# íë¦„:
# 1. feature-branch í‘¸ì‹œ â†’ ì´ë¯¸ì§€ ë¹Œë“œ (sha íƒœê·¸)
# 2. Preview ì„œë²„ ë°°í¬ (Backup: 141.164.37.63)
# 3. PR ë¨¸ì§€ â†’ ê°™ì€ ì´ë¯¸ì§€ë¥¼ latestë¡œ íƒœê·¸
# 4. Production ì„œë²„ ë°°í¬ (App: 158.247.203.55)
# 5. Preview í™˜ê²½ ìë™ ì‚­ì œ

name: ${PROJECT_NAME} CI/CD

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'fix/**'
      - 'hotfix/**'
  pull_request:
    types: [opened, synchronize, reopened, closed]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  APP_NAME: ${PROJECT_NAME}
  NODE_VERSION: '20'
  # Server IPs
  APP_SERVER: 158.247.203.55
  PREVIEW_SERVER: 141.164.37.63
  BASE_DOMAIN: ${BASE_DOMAIN}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Build Image (1ë²ˆë§Œ ë¹Œë“œ)
  # ============================================
  build:
    name: Build Image
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action != 'closed')

    outputs:
      image_sha: ${{ steps.vars.outputs.image_sha }}
      branch_slug: ${{ steps.vars.outputs.branch_slug }}
      is_main: ${{ steps.vars.outputs.is_main }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate variables
        id: vars
        run: |
          # SHA ê¸°ë°˜ ì´ë¯¸ì§€ íƒœê·¸ (ì´ ì´ë¯¸ì§€ê°€ Preview â†’ Production ëª¨ë‘ ì‚¬ìš©ë¨)
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "image_sha=sha-${SHA_SHORT}" >> $GITHUB_OUTPUT

          # ë¸Œëœì¹˜ slug ìƒì„±
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          SLUG=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-20)
          echo "branch_slug=$SLUG" >> $GITHUB_OUTPUT

          # main ë¸Œëœì¹˜ ì—¬ë¶€
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

      - name: Summary
        run: |
          echo "### ğŸ“¦ Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Preview Deploy (feature ë¸Œëœì¹˜)
  # ============================================
  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build
    if: |
      needs.build.outputs.is_main == 'false' &&
      github.event.action != 'closed'

    outputs:
      preview_url: ${{ steps.deploy.outputs.preview_url }}

    steps:
      - name: Calculate preview port
        id: port
        run: |
          # ë¸Œëœì¹˜ í•´ì‹œ ê¸°ë°˜ í¬íŠ¸ (5000-5999)
          HASH=$(echo -n "${{ needs.build.outputs.branch_slug }}" | md5sum | cut -c1-4)
          PORT=$((16#$HASH % 1000 + 5000))
          echo "port=$PORT" >> $GITHUB_OUTPUT

      - name: Deploy to Preview Server
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_sha }}
          CONTAINER: ${{ env.APP_NAME }}-preview-${{ needs.build.outputs.branch_slug }}
          PORT: ${{ steps.port.outputs.port }}
          BRANCH_SLUG: ${{ needs.build.outputs.branch_slug }}
        with:
          host: ${{ env.PREVIEW_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE,CONTAINER,PORT,BRANCH_SLUG,APP_NAME,BASE_DOMAIN
          script: |
            set -e
            echo "ğŸš€ Deploying Preview: $CONTAINER"

            # Pull image
            podman pull $IMAGE

            # Stop existing
            podman stop $CONTAINER 2>/dev/null || true
            podman rm $CONTAINER 2>/dev/null || true

            # Ensure network
            podman network exists codeb-preview || podman network create codeb-preview

            # Run with runtime env injection
            podman run -d \
              --name $CONTAINER \
              --network codeb-preview \
              -p $PORT:3000 \
              --env-file /opt/codeb/env-backup/${APP_NAME}/preview.env \
              -e PREVIEW_BRANCH=$BRANCH_SLUG \
              --restart unless-stopped \
              $IMAGE

            # Register preview
            mkdir -p /opt/codeb/preview
            cat > /opt/codeb/preview/$CONTAINER.json << EOF
            {
              "project": "$APP_NAME",
              "branch": "$BRANCH_SLUG",
              "port": $PORT,
              "domain": "$BRANCH_SLUG.preview.$BASE_DOMAIN",
              "image": "$IMAGE",
              "createdAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
            EOF

            # Update Caddy
            mkdir -p /etc/caddy/preview.d
            cat > /etc/caddy/preview.d/${CONTAINER}.caddy << EOF
            $BRANCH_SLUG.preview.$BASE_DOMAIN {
              reverse_proxy localhost:$PORT
            }
            EOF
            systemctl reload caddy

            echo "âœ… Preview: https://$BRANCH_SLUG.preview.$BASE_DOMAIN"

      - name: Set outputs
        run: |
          echo "preview_url=https://${{ needs.build.outputs.branch_slug }}.preview.${{ env.BASE_DOMAIN }}" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸš€ Preview Deployed

            | | |
            |---|---|
            | **URL** | https://${{ needs.build.outputs.branch_slug }}.preview.${{ env.BASE_DOMAIN }} |
            | **Image** | \`${{ needs.build.outputs.image_sha }}\` |
            | **Port** | \`${{ steps.port.outputs.port }}\` |

            > ì´ ì´ë¯¸ì§€ê°€ PR ë¨¸ì§€ ì‹œ ê·¸ëŒ€ë¡œ Productionì— ë°°í¬ë©ë‹ˆë‹¤.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c => c.body.includes('Preview Deployed'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  # ============================================
  # Production Deploy (main ë¨¸ì§€ ì‹œ)
  # ============================================
  production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.is_main == 'true'

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote image to latest
        run: |
          # í…ŒìŠ¤íŠ¸ëœ ì´ë¯¸ì§€ë¥¼ latestë¡œ íƒœê·¸ (ì¬ë¹Œë“œ X)
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_sha }} \
                     ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          echo "âœ… Image promoted: ${{ needs.build.outputs.image_sha }} â†’ latest"

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          CONTAINER: ${{ env.APP_NAME }}
        with:
          host: ${{ env.APP_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE,CONTAINER,APP_NAME
          script: |
            set -e
            echo "ğŸš€ Deploying Production: $CONTAINER"

            # Pull promoted image
            podman pull $IMAGE

            # Graceful stop (not force kill)
            podman stop $CONTAINER --time 30 2>/dev/null || true
            podman rm $CONTAINER 2>/dev/null || true

            # Run with production env
            podman run -d \
              --name $CONTAINER \
              --network codeb-network \
              -p ${PRODUCTION_PORT}:3000 \
              --env-file /opt/codeb/projects/${APP_NAME}/.env \
              --restart unless-stopped \
              $IMAGE

            # Health check
            sleep 10
            for i in {1..10}; do
              if curl -sf http://localhost:${PRODUCTION_PORT}/api/health; then
                echo "âœ… Health check passed"
                exit 0
              fi
              sleep 3
            done
            echo "âŒ Health check failed"
            exit 1

      - name: Summary
        run: |
          echo "### ğŸ‰ Production Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ env.APP_NAME }}.${{ env.BASE_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ needs.build.outputs.image_sha }}\` (promoted to latest)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Preview Cleanup (PR ë‹«í˜/ë¨¸ì§€ ì‹œ)
  # ============================================
  cleanup:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    steps:
      - name: Generate branch slug
        id: vars
        run: |
          BRANCH="${{ github.head_ref }}"
          SLUG=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-20)
          echo "branch_slug=$SLUG" >> $GITHUB_OUTPUT
          echo "container=${{ env.APP_NAME }}-preview-${SLUG}" >> $GITHUB_OUTPUT

      - name: Cleanup Preview Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          CONTAINER: ${{ steps.vars.outputs.container }}
        with:
          host: ${{ env.PREVIEW_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: CONTAINER
          script: |
            echo "ğŸ§¹ Cleaning: $CONTAINER"
            podman stop $CONTAINER 2>/dev/null || true
            podman rm $CONTAINER 2>/dev/null || true
            rm -f /opt/codeb/preview/$CONTAINER.json
            rm -f /etc/caddy/preview.d/${CONTAINER}.caddy
            systemctl reload caddy
            podman image prune -f
            echo "âœ… Cleanup complete"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const merged = '${{ github.event.pull_request.merged }}' === 'true';
            const body = merged
              ? `## ğŸ‰ Merged & Deployed\n\nPreview í™˜ê²½ì´ ì‚­ì œë˜ì—ˆê³ , ê°™ì€ ì´ë¯¸ì§€ê°€ Productionì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.`
              : `## ğŸ§¹ Preview Cleaned\n\nPRì´ ë‹«í˜€ì„œ Preview í™˜ê²½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
