/**
 * Environment File Generator
 *
 * Generates environment files for server and local development
 * - Server ENV content (production/staging)
 * - Local ENV content (development)
 * - Storage/Streaming server configuration
 */

import { getCliVersion } from '../../lib/config.js';

// Server infrastructure configuration
const STORAGE_SERVER = {
  host: 'db.codeb.kr',
  ip: '64.176.226.119',
  postgresPort: 5432,
  redisPort: 6379
};

const STREAMING_SERVER = {
  host: 'ws.codeb.kr',
  ip: '141.164.42.213',
  port: 8000
};

/**
 * Generate server environment file content
 * Uses Storage server (db.codeb.kr) for centralized DB/Redis
 * @param {Object} config - Configuration
 * @returns {string} ENV file content
 */
export function generateServerEnvContent(config) {
  const {
    projectName,
    environment = 'production',
    port = 3000,
    database,
    redis,
    storage
  } = config;

  let content = `# ${projectName} - ${environment.charAt(0).toUpperCase() + environment.slice(1)} Environment
# Generated by CodeB CLI v${getCliVersion()}

NODE_ENV=${environment}
PORT=${port}
HOSTNAME=0.0.0.0
`;

  if (database) {
    content += `
# PostgreSQL (Storage server: ${STORAGE_SERVER.host})
DATABASE_URL=postgresql://${database.user}:${database.password}@${STORAGE_SERVER.host}:${STORAGE_SERVER.postgresPort}/${database.database}?schema=public
POSTGRES_HOST=${STORAGE_SERVER.host}
POSTGRES_PORT=${STORAGE_SERVER.postgresPort}
POSTGRES_USER=${database.user}
POSTGRES_PASSWORD=${database.password}
POSTGRES_DB=${database.database}
`;
  }

  if (redis) {
    content += `
# Redis (Storage server: ${STORAGE_SERVER.host})
REDIS_URL=redis://${STORAGE_SERVER.host}:${STORAGE_SERVER.redisPort}/${redis.db_index}
REDIS_HOST=${STORAGE_SERVER.host}
REDIS_PORT=${STORAGE_SERVER.redisPort}
REDIS_DB=${redis.db_index}
REDIS_PREFIX=${redis.prefix}

# Centrifugo (Streaming server: ${STREAMING_SERVER.host})
CENTRIFUGO_URL=wss://${STREAMING_SERVER.host}/connection/websocket
CENTRIFUGO_API_URL=http://${STREAMING_SERVER.host}:${STREAMING_SERVER.port}/api
CENTRIFUGO_API_KEY=pRMupNs6HlGp7G6xkPsAFrI8hN4g6U0G
CENTRIFUGO_SECRET=of0KuRFjjzhq5LlBURCuKqzTUAA08hwL
`;
  }

  if (storage) {
    content += `
# Storage
STORAGE_PATH=/data
UPLOAD_PATH=/data/uploads
CACHE_PATH=/data/cache
`;
  }

  return content;
}

/**
 * Generate local .env.local content for development
 * @param {Object} config - Configuration
 * @returns {string} ENV file content
 */
export function generateLocalEnvContent(config) {
  const {
    projectName,
    serverHost,
    database,
    redis,
    dbExternalPort = 5432,
    redisExternalPort = 6379
  } = config;

  let content = `# ${projectName} - Local Development Environment
# Generated by CodeB CLI v${getCliVersion()}
# WARNING: This connects to REAL server data!

NODE_ENV=development
PORT=3000
`;

  if (database && serverHost) {
    content += `
# PostgreSQL (external server port)
DATABASE_URL=postgresql://${database.user}:${database.password}@${serverHost}:${dbExternalPort}/${database.database}?schema=public
`;
  }

  if (redis && serverHost) {
    content += `
# Redis (external server port)
REDIS_URL=redis://${serverHost}:${redisExternalPort}/${redis.db_index}
REDIS_PREFIX=${redis.prefix}

# Centrifugo (realtime messaging - development)
CENTRIFUGO_URL=wss://ws.codeb.kr/connection/websocket
CENTRIFUGO_API_URL=http://ws.codeb.kr:8000/api
CENTRIFUGO_API_KEY=pRMupNs6HlGp7G6xkPsAFrI8hN4g6U0G
CENTRIFUGO_SECRET=of0KuRFjjzhq5LlBURCuKqzTUAA08hwL
`;
  }

  content += `
# Storage (local paths for development)
STORAGE_PATH=./data
UPLOAD_PATH=./data/uploads
CACHE_PATH=./data/cache
`;

  return content;
}
