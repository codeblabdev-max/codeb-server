# CodeB CI/CD Pipeline - Private Docker Registry
# Generated by CodeB CLI v7.0.65
#
# ì „ëµ: Private Registry + Blue-Green Deployment
#
# ì•„í‚¤í…ì²˜:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  [GitHub Actions] â†’ [Private Registry] â†’ [App Server]          â”‚
# â”‚       â”‚                  (Storage)           (Docker)           â”‚
# â”‚       â”‚             64.176.226.119:5000    158.247.203.55       â”‚
# â”‚       â–¼                     â–²                   â”‚               â”‚
# â”‚  docker build & push â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚               â”‚
# â”‚                     docker pull â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ì¥ì :
# - ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë¡œ ë¹ ë¥¸ push/pull
# - GHCR ì˜ì¡´ì„± ì œê±°
# - GitHub ì¥ì•  ì‹œì—ë„ ë°°í¬ ê°€ëŠ¥
# - ë¹„ìš© ì ˆê° (GitHub Storage ë¯¸ì‚¬ìš©)

name: ${PROJECT_NAME} CI/CD

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'fix/**'
      - 'hotfix/**'
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force rebuild (skip cache)'
        type: boolean
        default: false

env:
  # Private Registry (Storage Server)
  REGISTRY: 64.176.226.119:5000
  IMAGE_NAME: ${PROJECT_NAME}
  APP_NAME: ${PROJECT_NAME}
  NODE_VERSION: '20'

  # Server IPs (CodeB 4-Server Architecture)
  APP_SERVER: 158.247.203.55
  STORAGE_SERVER: 64.176.226.119
  PREVIEW_SERVER: 141.164.37.63

  BASE_DOMAIN: ${BASE_DOMAIN}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Build & Push to Private Registry
  # ============================================
  build:
    name: Build & Push
    runs-on: self-hosted
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      github.event_name == 'workflow_dispatch'

    outputs:
      image_tag: ${{ steps.vars.outputs.image_tag }}
      image_sha: ${{ steps.vars.outputs.image_sha }}
      branch_slug: ${{ steps.vars.outputs.branch_slug }}
      is_main: ${{ steps.vars.outputs.is_main }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate variables
        id: vars
        run: |
          # SHA ê¸°ë°˜ ì´ë¯¸ì§€ íƒœê·¸
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "image_sha=sha-${SHA_SHORT}" >> $GITHUB_OUTPUT

          # ë¸Œëœì¹˜ slug ìƒì„±
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          SLUG=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-20)
          echo "branch_slug=$SLUG" >> $GITHUB_OUTPUT

          # main ë¸Œëœì¹˜ ì—¬ë¶€
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
            echo "image_tag=latest" >> $GITHUB_OUTPUT
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
            echo "image_tag=sha-${SHA_SHORT}" >> $GITHUB_OUTPUT
          fi

      - name: Check cache (Incremental Build)
        id: cache
        if: github.event.inputs.force_build != 'true'
        run: |
          # NPM í•´ì‹œ (package-lock.json)
          NPM_HASH=$(sha256sum package-lock.json 2>/dev/null | head -c 16 || echo "no-lock")

          # SRC í•´ì‹œ (src/**/*.ts, src/**/*.tsx)
          SRC_HASH=$(find src -type f \( -name "*.ts" -o -name "*.tsx" \) 2>/dev/null | sort | xargs cat 2>/dev/null | sha256sum | head -c 16 || echo "no-src")

          CACHE_KEY="${NPM_HASH}-${SRC_HASH}"
          echo "cache_key=$CACHE_KEY" >> $GITHUB_OUTPUT

          # Private Registryì—ì„œ ìºì‹œ í™•ì¸
          CACHED_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache-${CACHE_KEY}"
          if docker manifest inspect "$CACHED_IMAGE" > /dev/null 2>&1; then
            echo "cache_hit=true" >> $GITHUB_OUTPUT
            echo "cached_image=$CACHED_IMAGE" >> $GITHUB_OUTPUT
            echo "âœ… Cache hit: $CACHED_IMAGE"
          else
            echo "cache_hit=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Cache miss, will build"
          fi

      - name: Use cached image (skip build)
        if: steps.cache.outputs.cache_hit == 'true'
        run: |
          CACHED="${{ steps.cache.outputs.cached_image }}"
          TARGET="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }}"

          docker pull "$CACHED"
          docker tag "$CACHED" "$TARGET"
          docker push "$TARGET"

          echo "âœ… Reused cached image: $TARGET"

      - name: Build Docker image
        if: steps.cache.outputs.cache_hit != 'true'
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }}"

          docker build \
            --build-arg NODE_ENV=production \
            --cache-from "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" \
            -t "$IMAGE" \
            .

          echo "âœ… Built: $IMAGE"

      - name: Push to Private Registry
        if: steps.cache.outputs.cache_hit != 'true'
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }}"
          CACHE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache-${{ steps.cache.outputs.cache_key }}"

          # Push main image
          docker push "$IMAGE"

          # Push cache image (for incremental build)
          docker tag "$IMAGE" "$CACHE_IMAGE"
          docker push "$CACHE_IMAGE"

          echo "âœ… Pushed: $IMAGE"
          echo "âœ… Cached: $CACHE_IMAGE"

      - name: Summary
        run: |
          echo "### ğŸ“¦ Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Registry** | Private (\`${{ env.REGISTRY }}\`) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cache** | ${{ steps.cache.outputs.cache_hit == 'true' && 'âœ… Hit' || 'ğŸ“¦ Miss' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Production (main branch)
  # ============================================
  deploy-production:
    name: Deploy Production
    runs-on: self-hosted
    needs: build
    if: needs.build.outputs.is_main == 'true'
    environment:
      name: production
      url: https://${{ env.APP_NAME }}.${{ env.BASE_DOMAIN }}

    steps:
      - name: Deploy via MCP API
        run: |
          # MCP APIë¥¼ í†µí•œ Blue-Green ë°°í¬
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_tag }}"

          RESPONSE=$(curl -sf -X POST "https://api.codeb.kr/api/deploy" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -d '{
              "projectName": "${{ env.APP_NAME }}",
              "environment": "production",
              "image": "'"$IMAGE"'",
              "version": "${{ needs.build.outputs.image_sha }}"
            }')

          echo "$RESPONSE" | jq .

          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ Deploy failed"
            exit 1
          fi

          PREVIEW_URL=$(echo "$RESPONSE" | jq -r '.previewUrl')
          SLOT=$(echo "$RESPONSE" | jq -r '.slot')

          echo "âœ… Deployed to $SLOT slot"
          echo "ğŸ”— Preview: $PREVIEW_URL"

          # GitHub Summary
          echo "### ğŸš€ Production Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Slot** | \`$SLOT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Preview** | $PREVIEW_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`$IMAGE\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> Run \`/we:promote ${{ env.APP_NAME }}\` to switch traffic" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy Preview (feature branches)
  # ============================================
  deploy-preview:
    name: Deploy Preview
    runs-on: self-hosted
    needs: build
    if: |
      needs.build.outputs.is_main == 'false' &&
      github.event.action != 'closed'
    environment:
      name: preview
      url: https://${{ needs.build.outputs.branch_slug }}.preview.${{ env.BASE_DOMAIN }}

    steps:
      - name: Deploy Preview via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_tag }}
          CONTAINER: ${{ env.APP_NAME }}-preview-${{ needs.build.outputs.branch_slug }}
          BRANCH_SLUG: ${{ needs.build.outputs.branch_slug }}
        with:
          host: ${{ env.PREVIEW_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE,CONTAINER,BRANCH_SLUG,APP_NAME,REGISTRY
          script: |
            set -e
            echo "ğŸš€ Deploying Preview: $CONTAINER"

            # Pull from Private Registry
            docker pull $IMAGE

            # Stop existing
            docker stop $CONTAINER 2>/dev/null || true
            docker rm $CONTAINER 2>/dev/null || true

            # Calculate port (5000-5999)
            HASH=$(echo -n "$BRANCH_SLUG" | md5sum | cut -c1-4)
            PORT=$((16#$HASH % 1000 + 5000))

            # Run preview container
            docker run -d \
              --name $CONTAINER \
              -p $PORT:3000 \
              --env-file /opt/codeb/env-backup/${APP_NAME}/preview.env \
              -e PREVIEW_BRANCH=$BRANCH_SLUG \
              --restart unless-stopped \
              $IMAGE

            echo "âœ… Preview deployed on port $PORT"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸš€ Preview Deployed

            | Key | Value |
            |-----|-------|
            | **URL** | https://${{ needs.build.outputs.branch_slug }}.preview.${{ env.BASE_DOMAIN }} |
            | **Image** | \`${{ needs.build.outputs.image_tag }}\` |
            | **Registry** | Private (\`${{ env.REGISTRY }}\`) |

            > PR ë¨¸ì§€ ì‹œ ê°™ì€ ì´ë¯¸ì§€ê°€ Productionì— ë°°í¬ë©ë‹ˆë‹¤.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c => c.body.includes('Preview Deployed'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  # ============================================
  # Cleanup Preview (PR closed/merged)
  # ============================================
  cleanup-preview:
    name: Cleanup Preview
    runs-on: self-hosted
    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    steps:
      - name: Generate branch slug
        id: vars
        run: |
          BRANCH="${{ github.head_ref }}"
          SLUG=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-20)
          echo "branch_slug=$SLUG" >> $GITHUB_OUTPUT
          echo "container=${{ env.APP_NAME }}-preview-${SLUG}" >> $GITHUB_OUTPUT

      - name: Cleanup Preview Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          CONTAINER: ${{ steps.vars.outputs.container }}
        with:
          host: ${{ env.PREVIEW_SERVER }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: CONTAINER
          script: |
            echo "ğŸ§¹ Cleaning: $CONTAINER"
            docker stop $CONTAINER 2>/dev/null || true
            docker rm $CONTAINER 2>/dev/null || true
            docker image prune -f
            echo "âœ… Cleanup complete"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const merged = '${{ github.event.pull_request.merged }}' === 'true';
            const body = merged
              ? `## ğŸ‰ Merged & Deployed\n\nPreview í™˜ê²½ì´ ì‚­ì œë˜ì—ˆê³ , ê°™ì€ ì´ë¯¸ì§€ê°€ Productionì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.`
              : `## ğŸ§¹ Preview Cleaned\n\nPRì´ ë‹«í˜€ì„œ Preview í™˜ê²½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
