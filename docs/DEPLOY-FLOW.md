# CodeB v7.0 - 배포 플로우 가이드

> Blue-Green 배포 시스템의 전체 흐름과 각 단계별 동작
>
> **문서 버전**: 8.0.0
> **최종 업데이트**: 2026-02-06

---

## 목차

1. [배포 방식 개요](#1-배포-방식-개요)
2. [GitHub Actions CI/CD 플로우](#2-github-actions-cicd-플로우)
3. [Blue-Green 배포 단계](#3-blue-green-배포-단계)
4. [Slot 상태 관리](#4-slot-상태-관리)
5. [포트 할당 전략](#5-포트-할당-전략)
6. [데이터 흐름](#6-데이터-흐름)
7. [에러 처리](#7-에러-처리)

---

## 1. 배포 방식 개요

### 1.1 두 가지 배포 방식

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CodeB v7.0 배포 방식                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  방식 1: GitHub Actions CI/CD (일반 프로젝트 - workb, heeling 등)           │
│  ────────────────────────────────────────────────────────────────           │
│                                                                             │
│  [로컬] ──git push──→ [GitHub] ──trigger──→ [Self-Hosted Runner]           │
│                                                    │                        │
│                                      ┌─────────────┴─────────────┐          │
│                                      │  Docker BuildKit          │          │
│                                      │  + Minio S3 Cache         │          │
│                                      └─────────────┬─────────────┘          │
│                                                    │                        │
│                                                    ▼                        │
│                                      ┌─────────────────────────┐            │
│                                      │  Private Registry Push  │            │
│                                      │  64.176.226.119:5000    │            │
│                                      └─────────────┬───────────┘            │
│                                                    │                        │
│                                                    ▼                        │
│                                      ┌─────────────────────────┐            │
│                                      │  MCP API 호출           │            │
│                                      │  deploy_project(image)  │            │
│                                      └─────────────────────────┘            │
│                                                                             │
│  방식 2: 수동 배포 (codeb-server 전용)                                       │
│  ────────────────────────────────────────────────────────────────           │
│                                                                             │
│  [로컬] ──deploy-all.sh──→ [직접 빌드] ──SSH──→ [서버 배포]                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 배포 흐름 비교

| 단계 | GitHub Actions (workb) | 수동 (codeb-server) |
|------|------------------------|---------------------|
| 트리거 | `git push` | `./deploy-all.sh` |
| 빌드 위치 | Self-Hosted Runner | 로컬 |
| 빌드 캐시 | Minio S3 | 없음 |
| 이미지 저장 | Private Registry | 서버 직접 |
| 배포 API | MCP API (image 파라미터) | SSH + Docker |

---

## 2. GitHub Actions CI/CD 플로우

### 2.1 전체 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    GitHub Actions CI/CD 플로우 (workb 방식)                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐                                                           │
│  │  git push    │                                                           │
│  │  main branch │                                                           │
│  └──────┬───────┘                                                           │
│         │                                                                   │
│         ▼                                                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  GitHub Actions Workflow                                              │  │
│  │  runs-on: [self-hosted, docker]                                       │  │
│  ├──────────────────────────────────────────────────────────────────────┤  │
│  │                                                                       │  │
│  │  1. Checkout                                                          │  │
│  │     └─→ actions/checkout@v4                                          │  │
│  │                                                                       │  │
│  │  2. Setup Docker Buildx                                               │  │
│  │     └─→ docker/setup-buildx-action@v3                                │  │
│  │                                                                       │  │
│  │  3. Build with Minio S3 Cache ⭐                                      │  │
│  │     ┌────────────────────────────────────────────────────────────┐   │  │
│  │     │  docker buildx build \                                      │   │  │
│  │     │    --cache-from "type=s3,bucket=docker-cache,..."          │   │  │
│  │     │    --cache-to "type=s3,bucket=docker-cache,mode=max,..."   │   │  │
│  │     │    -t registry:5000/projectName:sha \                      │   │  │
│  │     │    --push .                                                │   │  │
│  │     └────────────────────────────────────────────────────────────┘   │  │
│  │                                                                       │  │
│  │  4. MCP API 호출 (Blue-Green 배포)                                    │  │
│  │     ┌────────────────────────────────────────────────────────────┐   │  │
│  │     │  curl -X POST "https://api.codeb.kr/api/tool" \             │   │  │
│  │     │    -H "X-API-Key: $CODEB_API_KEY" \                        │   │  │
│  │     │    -d '{                                                   │   │  │
│  │     │      "tool": "deploy",                                     │   │  │
│  │     │      "params": {                                           │   │  │
│  │     │        "projectName": "workb",                             │   │  │
│  │     │        "image": "64.176.226.119:5000/workb:sha"  ← 핵심!   │   │  │
│  │     │      }                                                     │   │  │
│  │     │    }'                                                      │   │  │
│  │     └────────────────────────────────────────────────────────────┘   │  │
│  │                                                                       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│         │                                                                   │
│         ▼                                                                   │
│  ┌──────────────────┐                                                       │
│  │  Preview URL     │  ← 비활성 슬롯에 배포됨                               │
│  │  검증 후         │                                                       │
│  │  /we:promote     │  ← 트래픽 전환                                        │
│  └──────────────────┘                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Minio S3 캐시 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                    Minio S3 Docker 캐시                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Storage Server: 64.176.226.119:9000                            │
│  Bucket: docker-cache                                           │
│                                                                 │
│  캐시 키 구조:                                                   │
│  docker-cache/                                                  │
│  ├── workb/                                                     │
│  │   ├── blobs/                                                 │
│  │   │   ├── sha256:abc123...  (레이어 캐시)                   │
│  │   │   └── sha256:def456...                                  │
│  │   └── manifests/                                             │
│  └── heeling/                                                   │
│      └── ...                                                    │
│                                                                 │
│  장점:                                                          │
│  ✅ 레이어 캐시로 빌드 시간 80% 단축                            │
│  ✅ Self-Hosted Runner와 같은 네트워크 (빠른 전송)              │
│  ✅ 프로젝트별 독립 캐시                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 Private Registry

```
┌─────────────────────────────────────────────────────────────────┐
│                    Private Docker Registry                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  주소: 64.176.226.119:5000                                      │
│  프로토콜: HTTP (내부망, insecure-registries 설정 필요)         │
│                                                                 │
│  이미지 태그 규칙:                                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  64.176.226.119:5000/{projectName}:{tag}                │    │
│  │                                                          │    │
│  │  예시:                                                   │    │
│  │  - 64.176.226.119:5000/workb:abc123def  (commit sha)    │    │
│  │  - 64.176.226.119:5000/workb:latest     (최신)          │    │
│  │  - 64.176.226.119:5000/heeling:v1.0.0   (태그)          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  확인 명령:                                                     │
│  curl http://64.176.226.119:5000/v2/_catalog                   │
│  curl http://64.176.226.119:5000/v2/workb/tags/list            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Blue-Green 배포 단계

### 3.1 배포 단계 (`/we:deploy` 또는 MCP API)

```
┌──────────────────┐
│  deploy_project  │
│  (MCP API 호출)  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     실패
│ 1. API Key 인증  │────────────▶ Access Denied
│    (X-API-Key)   │
└────────┬─────────┘
         │ 성공
         ▼
┌──────────────────┐     신규 프로젝트
│ 2. Slot Registry │────────────────────────┐
│    조회          │                        │
└────────┬─────────┘                        │
         │ 기존 프로젝트                    │
         ▼                                  ▼
┌──────────────────┐              ┌──────────────────┐
│ 3. 반대 슬롯     │              │ 3. 포트 할당     │
│    선택          │              │    (SSOT)        │
│ (blue↔green)     │              │ prod: 4100-4499  │
└────────┬─────────┘              └────────┬─────────┘
         │                                 │
         └─────────────┬───────────────────┘
                       ▼
         ┌──────────────────┐     실패 (이미지 없음)
         │ 4. Docker Pull   │────────────▶ Error
         │    (image 파라미터)│
         └────────┬─────────┘
                  │ 성공
                  ▼
         ┌──────────────────┐
         │ 5. 기존 컨테이너 │
         │    정리          │
         └────────┬─────────┘
                  │
                  ▼
         ┌──────────────────┐     실패
         │ 6. Docker Run    │────────────▶ 롤백
         │    (새 컨테이너) │
         └────────┬─────────┘
                  │ 성공
                  ▼
         ┌──────────────────┐     실패 (60초 타임아웃)
         │ 7. Health Check  │────────────▶ 컨테이너 정리
         │    - Docker      │
         │    - curl /health│
         └────────┬─────────┘
                  │ 성공
                  ▼
         ┌──────────────────┐
         │ 8. Registry      │
         │    업데이트      │
         │  (File + DB)     │
         └────────┬─────────┘
                  │
                  ▼
         ┌──────────────────┐
         │ ✅ Preview URL   │
         │ 반환             │
         └──────────────────┘
```

### 3.2 프로모트 단계 (`/we:promote`)

```
┌──────────────────┐
│  /we:promote     │
│  projectName     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     실패
│ 1. Slot Registry │────────────▶ Error
│    조회          │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     state != 'deployed'
│ 2. 배포 상태     │────────────▶ "Run deploy first"
│    확인          │
└────────┬─────────┘
         │ state == 'deployed'
         ▼
┌──────────────────┐     HTTP 2xx/3xx 아님
│ 3. Final Health  │────────────▶ Health Check Failed
│    Check         │
└────────┬─────────┘
         │ 성공
         ▼
┌──────────────────┐
│ 4. Caddy 설정    │
│    생성          │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 5. Caddy Reload  │  ◀── 무중단 (0초 다운타임)
│  (systemctl)     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 6. Slot 상태     │
│    업데이트      │
│ - 새 슬롯: active│
│ - 이전: grace    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ ✅ Production    │
│    URL 반환      │
└──────────────────┘
```

### 3.3 롤백 단계 (`/we:rollback`)

```
┌──────────────────┐
│  /we:rollback    │
│  projectName     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     grace 슬롯 없음
│ 1. Grace 슬롯    │────────────▶ "No grace slot"
│    확인          │
└────────┬─────────┘
         │ grace 슬롯 존재
         ▼
┌──────────────────┐     HTTP 2xx/3xx 아님
│ 2. Grace 슬롯    │────────────▶ "Grace slot unhealthy"
│    헬스체크      │
└────────┬─────────┘
         │ 성공
         ▼
┌──────────────────┐
│ 3. Caddy 설정    │  ◀── promote와 동일
│    업데이트      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 4. Slot 상태     │
│    스왑          │
│ - grace → active │
│ - active → grace │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ ✅ Rollback      │
│    완료          │
└──────────────────┘
```

---

## 4. Slot 상태 관리

### 4.1 Slot 상태 전이

```
┌─────────┐     deploy      ┌──────────┐    promote     ┌────────┐
│  empty  │ ───────────────▶│ deployed │ ──────────────▶│ active │
└─────────┘                 └──────────┘                └────────┘
     ▲                                                       │
     │                                                       │
     │                    ┌─────────┐                        │
     │    cleanup         │  grace  │◀───────────────────────┘
     └────────────────────│(48시간) │       promote (다른 슬롯)
                          └─────────┘
```

### 4.2 상태별 의미

| 상태 | 설명 | 전이 조건 |
|------|------|----------|
| empty | 빈 슬롯 | cleanup 완료 |
| deployed | 배포됨 (대기) | deploy 성공, Preview URL 사용 가능 |
| active | 프로덕션 트래픽 | promote 성공 |
| grace | 롤백 대기 (48h) | 다른 슬롯 promote, 롤백 가능 |

---

## 5. 포트 할당 전략

### 5.1 포트 범위

| 환경 | 범위 | Blue | Green |
|------|------|------|-------|
| Production | 4100-4499 | 짝수 (4100) | 홀수 (4101) |
| Staging | 4500-4999 | 짝수 (4500) | 홀수 (4501) |
| Preview | 5000-5499 | 짝수 (5000) | 홀수 (5001) |

### 5.2 SSOT 구조

```json
// /opt/codeb/registry/ssot.json
{
  "ports": {
    "used": [4100, 4101, 4102, 4103],
    "allocated": {
      "4100": "project-a",
      "4101": "project-a",
      "4102": "project-b",
      "4103": "project-b"
    }
  }
}
```

### 5.3 포트 할당 로직

```
1. SSOT 파일에서 등록된 포트 조회
2. 실행 중인 Docker 컨테이너 포트 조회
3. ss/netstat으로 리스닝 포트 조회
4. 모든 소스 결합 → 다음 사용 가능한 짝수 포트 할당
   (blue: 짝수, green: 홀수)
```

---

## 6. 데이터 흐름

### 6.1 저장소 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           데이터 저장소                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐        ┌─────────────────┐                        │
│  │   파일 시스템    │        │   PostgreSQL    │                        │
│  │   (Primary)     │ ─────▶ │   (Secondary)   │                        │
│  └─────────────────┘  동기화 └─────────────────┘                        │
│          │                          │                                   │
│          │                          │                                   │
│  /opt/codeb/registry/        teams, api_keys,                          │
│  ├── ssot.json               projects, project_slots,                  │
│  └── slots/                  deployments, audit_logs                   │
│      ├── project-a-prod.json                                           │
│      └── project-b-staging.json                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 동기화 전략

- **Write**: 파일 먼저 → DB 동기화 (실패해도 계속)
- **Read**: 파일 기반 (Primary Source)
- **Query**: DB 사용 (팀별 조회, 검색 등)

---

## 7. 에러 처리

### 7.1 배포 실패 시

```
1. Docker 이미지 pull 실패
   └─→ "Image not found" 에러
   └─→ GitHub Actions가 빌드하지 않았으면 이미지 없음!
   └─→ 해결: git push로 빌드 트리거

2. 컨테이너 시작 실패
   └─→ 컨테이너 정리, 이전 상태 유지

3. 헬스체크 실패
   └─→ 컨테이너 정리, 이전 상태 유지
```

### 7.2 프로모트 실패 시

```
1. 슬롯 상태 불일치 → "Run deploy first" 반환
2. 헬스체크 실패 → 프로모트 중단, 이전 트래픽 유지
3. Caddy 설정 실패 → 백업에서 복원
```

---

## 관련 파일

| 파일 | 역할 |
|------|------|
| `mcp-server/src/tools/deploy.ts` | 배포 실행 |
| `mcp-server/src/tools/promote.ts` | 트래픽 전환 |
| `mcp-server/src/tools/rollback.ts` | 롤백 실행 |
| `mcp-server/src/tools/slot.ts` | Slot 레지스트리 관리 |
| `mcp-server/src/tools/project.ts` | 프로젝트 초기화 (workflow_init) |
| `mcp-server/src/tools/domain.ts` | 도메인 관리 |
| `mcp-server/src/lib/caddy.ts` | Caddy 설정 통합 관리 |
| `mcp-server/src/lib/database.ts` | PostgreSQL 연동 |
| `mcp-server/src/lib/ssh.ts` | SSH 연결 관리 |

---

## 관련 문서

- [KNOWN-ISSUES.md](./KNOWN-ISSUES.md) - 알려진 문제점 및 해결 방안
- [deployment-guide.md](./deployment-guide.md) - 배포 가이드
- [PRIVATE-REGISTRY.md](./PRIVATE-REGISTRY.md) - Private Registry 가이드
