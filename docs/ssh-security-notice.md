# SSH 보안 강화 공지

> **작성일:** 2025-02-10
> **작성자:** 인프라팀
> **긴급도:** CRITICAL
> **적용 대상:** CodeB 전체 서버 (4대)

---

## 1. 현재 상황

### 서버에 SSH 브루트포스 공격이 진행 중입니다

외부 공격자들이 App 서버(158.247.203.55)에 **초당 1회 이상** 패스워드 추측 공격을 시도하고 있습니다.

```
[실제 로그 발췌]
Feb  9 23:52:13 sshd: Invalid user "user" from 84.60.230.117
Feb  9 23:52:19 sshd: Invalid user "oracle" from 178.62.255.28
Feb  9 23:52:22 sshd: Failed password for root from 103.148.195.198
Feb  9 23:52:39 sshd: Failed password for www-data from 142.93.135.61
Feb  9 23:52:41 sshd: Invalid user "hadoop" from 167.99.43.73
```

| 공격 IP | 공격 패턴 | 빈도 |
|---------|----------|------|
| 84.60.230.117 | "user" 계정 반복 시도 | 초당 1회 이상 |
| 142.93.135.61 | "www-data" 계정 시도 | 수시 |
| 178.62.255.28 | "oracle" 계정 시도 | 수시 |
| 103.148.195.198 | "root" 계정 시도 | 수시 |
| 167.99.43.73 | "hadoop" 계정 시도 | 수시 |

### 현재 서버 SSH 설정이 취약합니다

4대 서버 모두 아래 상태입니다:

| 설정 | 현재 값 | 위험도 |
|------|---------|--------|
| PasswordAuthentication | **yes (열림)** | CRITICAL |
| PermitRootLogin | **yes** | CRITICAL |
| fail2ban | **미설치** | HIGH |

> **패스워드 인증이 열려있어서, 공격자가 비밀번호를 맞추면 서버에 접속할 수 있는 상태입니다.**

---

## 2. 적용할 보안 조치

### 조치 1: SSH 패스워드 인증 비활성화

```
변경 전: PasswordAuthentication yes    (패스워드로 로그인 가능)
변경 후: PasswordAuthentication no     (SSH 키로만 로그인 가능)
```

- SSH 키가 등록된 사람만 접속할 수 있습니다.
- 패스워드를 아무리 맞춰도 접속이 **불가능**합니다.
- 브루트포스 공격이 원천 차단됩니다.

### 조치 2: root 로그인 제한

```
변경 전: PermitRootLogin yes               (패스워드로 root 로그인 가능)
변경 후: PermitRootLogin prohibit-password  (root는 SSH 키로만 로그인 가능)
```

### 조치 3: fail2ban 설치

- 로그인 실패를 반복하는 IP를 자동 차단합니다.
- 5회 실패 시 해당 IP를 10분간 차단합니다.

### 조치 4: 공격 IP 즉시 차단

위 표의 공격 IP 5개를 방화벽에서 영구 차단합니다.

---

## 3. 팀원에게 미치는 영향

### 영향 없는 경우 (대부분)

현재 팀원들은 **이미 SSH 키로 접속하고 있습니다.** 아래 명령어로 접속하고 있다면 영향 없습니다:

```bash
# 이런 방식으로 접속하고 있으면 영향 없음
ssh root@158.247.203.55
# → 자동으로 SSH 키가 사용되어 비밀번호 입력 없이 접속됨
```

### 영향 있는 경우

만약 접속 시 **비밀번호를 직접 입력**하고 있다면, 적용 후 접속이 차단됩니다:

```bash
# 이런 방식이면 적용 후 접속 불가
ssh root@158.247.203.55
# → "Password:" 프롬프트가 뜨고 비밀번호를 입력하는 경우
```

---

## 4. SSH 키 등록 확인 방법

### 내 SSH 키가 있는지 확인

로컬 맥/PC 터미널에서:

```bash
ls -la ~/.ssh/id_*.pub
```

결과가 나오면 SSH 키가 있는 것입니다:
```
-rw-r--r--  1 user  staff  xxx  .ssh/id_ed25519.pub
-rw-r--r--  1 user  staff  xxx  .ssh/id_rsa.pub
```

`No such file or directory` 가 나오면 SSH 키가 없는 것입니다.

### SSH 키가 없는 경우 - 키 생성

```bash
# ED25519 키 생성 (권장)
ssh-keygen -t ed25519 -C "your-email@example.com"

# 엔터 3번 (기본 경로, 패스프레이즈 없음)
```

### 생성한 키를 서버에 등록

키 생성 후, **인프라팀에 공개키를 전달**해주세요:

```bash
# 공개키 내용 확인 (이 내용을 공유)
cat ~/.ssh/id_ed25519.pub
```

출력 예시:
```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... your-email@example.com
```

> 이 내용을 인프라팀에 전달하면 서버에 등록해드립니다.
> **절대로 `id_ed25519` (확장자 없는 파일)은 공유하지 마세요. 이것은 비밀키입니다.**

---

## 5. 현재 서버에 등록된 SSH 키 목록

### app-caddy-dns (158.247.203.55) - 6개 키

| 소유자 | 키 타입 | 비고 |
|--------|---------|------|
| cheon43@gmail.com | RSA | 관리자 |
| codeb-mcp-server | RSA | MCP 자동화 |
| ymn9639@gmail.com | ED25519 | 팀원 |
| prsuw113@naver.com | ED25519 | 팀원 |
| wori-landing-deploy | ED25519 | 배포 키 |
| becky@codeb | ED25519 | 팀원 |

### socket-mail-media (141.164.42.213) - 2개 키

| 소유자 | 키 타입 |
|--------|---------|
| cheon43@gmail.com | RSA |
| codeb-mcp-server | RSA |

### db-redis-minio (64.176.226.119) - 2개 키

| 소유자 | 키 타입 |
|--------|---------|
| cheon43@gmail.com | RSA |
| codeb-mcp-server | RSA |

### backup-monitor (141.164.37.63) - 3개 키

| 소유자 | 키 타입 | 비고 |
|--------|---------|------|
| Storage 서버 root | RSA | 서버간 백업용 |
| cheon43@gmail.com | RSA | 관리자 |
| codeb-mcp-server | RSA | MCP 자동화 |

---

## 6. 적용 대상 서버

| 서버명 | IP | 역할 |
|--------|-----|------|
| app-caddy-dns | 158.247.203.55 | App, Caddy, Docker, MCP API |
| socket-mail-media | 141.164.42.213 | Centrifugo, MediaMTX, Mail |
| db-redis-minio | 64.176.226.119 | PostgreSQL, Redis, MinIO |
| backup-monitor | 141.164.37.63 | Prometheus, Grafana, Backup |

---

## 7. 팀원 체크리스트

적용 전에 아래 사항을 확인해주세요:

- [ ] `ssh root@158.247.203.55` 접속 시 비밀번호 입력 없이 접속되는지 확인
- [ ] 비밀번호를 입력해야 접속된다면, SSH 키 생성 후 인프라팀에 공개키 전달
- [ ] GitHub Actions, CI/CD 등 자동화에서 패스워드 기반 SSH를 사용하는 곳이 있는지 확인

---

## 8. 긴급 연락

적용 후 접속에 문제가 생기면:

- Vultr 콘솔 (KVM)을 통해 직접 서버에 접속하여 복구 가능
- https://my.vultr.com → 해당 서버 → View Console

---

## 9. 참고: 적용 전후 비교

```
┌─────────────────────────────────────────────────────┐
│                    적용 전 (현재)                      │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [팀원 SSH 키]  ──→  서버 접속 ✅                    │
│  [팀원 패스워드] ──→  서버 접속 ✅ (위험!)            │
│  [공격자 추측]   ──→  서버 접속 시도 가능 ⚠️         │
│                                                     │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                    적용 후                            │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [팀원 SSH 키]  ──→  서버 접속 ✅                    │
│  [팀원 패스워드] ──→  접속 차단 🔒                    │
│  [공격자 추측]   ──→  접속 차단 🔒 + IP 차단 🚫      │
│                                                     │
└─────────────────────────────────────────────────────┘
```
