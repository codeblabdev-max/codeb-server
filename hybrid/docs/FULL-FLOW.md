# CodeB 하이브리드 배포 - 전체 플로우 상세

> SSOT, 포트, ENV 처리를 포함한 완전한 배포 플로우

---

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          CodeB 배포 시스템 전체 구조                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   개발자 PC                           서버 인프라                                │
│   ┌────────────────┐                 ┌──────────────────────────────────────┐   │
│   │ Claude Code    │                 │                                      │   │
│   │                │                 │  App Server (158.247.203.55)         │   │
│   │ /we:workflow   │ ── MCP API ───→ │  ├─ /opt/codeb/registry/ssot.json   │   │
│   │ /we:env sync   │     (9101)      │  ├─ /opt/codeb/registry/slots/      │   │
│   │ /we:domain     │                 │  ├─ /opt/codeb/env/{project}/       │   │
│   │ /we:deploy     │                 │  ├─ /etc/caddy/sites/               │   │
│   │ /we:promote    │                 │  └─ Docker containers               │   │
│   └────────────────┘                 │                                      │   │
│          │                           ├──────────────────────────────────────┤   │
│          │                           │  Storage Server (64.176.226.119)     │   │
│          │ git push                  │  ├─ PostgreSQL (5432)                │   │
│          ▼                           │  └─ Redis (6379)                     │   │
│   ┌────────────────┐                 └──────────────────────────────────────┘   │
│   │ GitHub Actions │                                                            │
│   │                │                                                            │
│   │ ┌────────────┐ │                                                            │
│   │ │Self-hosted │ │ ─── 직접 실행 ───────────────────────────────────────────→ │
│   │ │SSH         │ │ ─── SSH 접속 ────────────────────────────────────────────→ │
│   │ │API         │ │ ─── curl API ────────────────────────────────────────────→ │
│   │ └────────────┘ │                                                            │
│   └────────────────┘                                                            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## PHASE 1: 프로젝트 초기화 (workflow_init)

### 1.1 트리거

```bash
# Claude Code에서 실행
/we:workflow init myapp
```

### 1.2 MCP API 호출

```
POST https://api.codeb.kr/api/tool
{
  "tool": "workflow_init",
  "params": {
    "projectName": "myapp",
    "type": "nextjs",
    "database": true,
    "redis": true
  }
}
```

### 1.3 서버 처리 단계 (project.ts)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Phase 1-1: App Server (158.247.203.55) - SSH 연결                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Step 1: 프로젝트 디렉토리 생성                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ mkdir -p /opt/codeb/projects/myapp                                      │   │
│  │ mkdir -p /opt/codeb/env/myapp                                           │   │
│  │ mkdir -p /opt/codeb/env-backup/myapp                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 2: 포트 할당 (SSOT 동기화)                                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /opt/codeb/registry/ssot.json 읽기                                    │   │
│  │ {                                                                       │   │
│  │   "version": "7.0",                                                     │   │
│  │   "ports": {                                                            │   │
│  │     "allocated": {                                                      │   │
│  │       "4100": { "project": "existing1", "slot": "blue" },              │   │
│  │       "4101": { "project": "existing1", "slot": "green" }              │   │
│  │     }                                                                   │   │
│  │   }                                                                     │   │
│  │ }                                                                       │   │
│  │                                                                         │   │
│  │ # 포트 범위에서 사용 가능한 포트 찾기                                     │   │
│  │ Production: 4100-4498 (짝수=blue, 홀수=green)                           │   │
│  │                                                                         │   │
│  │ # 결과: myapp에 4102(blue), 4103(green) 할당                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 3: 슬롯 레지스트리 생성                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /opt/codeb/registry/slots/myapp-production.json 생성                  │   │
│  │ {                                                                       │   │
│  │   "projectName": "myapp",                                               │   │
│  │   "teamId": "team_abc123",                                              │   │
│  │   "environment": "production",                                          │   │
│  │   "activeSlot": "blue",                                                 │   │
│  │   "blue": { "name": "blue", "state": "empty", "port": 4102 },          │   │
│  │   "green": { "name": "green", "state": "empty", "port": 4103 },        │   │
│  │   "lastUpdated": "2026-01-14T10:00:00Z"                                 │   │
│  │ }                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ Phase 1-2: Storage Server (64.176.226.119) - SSH 연결                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Step 4: PostgreSQL DB/User 생성                                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ sudo -u postgres psql -c "CREATE DATABASE myapp_db;"                    │   │
│  │ sudo -u postgres psql -c "CREATE USER myapp_user WITH PASSWORD 'xxx';"  │   │
│  │ sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE myapp_db..."│   │
│  │ sudo -u postgres psql -c "ALTER DATABASE myapp_db OWNER TO myapp_user;" │   │
│  │                                                                         │   │
│  │ 결과:                                                                    │   │
│  │ - DB Name: myapp_db                                                     │   │
│  │ - DB User: myapp_user                                                   │   │
│  │ - Password: 32자 랜덤 생성                                               │   │
│  │ - URL: postgresql://myapp_user:xxx@db.codeb.kr:5432/myapp_db            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 5: Redis DB 번호 할당                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /opt/codeb/registry/redis-db.json 읽기/업데이트                        │   │
│  │ {                                                                       │   │
│  │   "used": { "existing1": 1, "myapp": 2 },  ← myapp에 DB 2 할당         │   │
│  │   "nextDb": 3                                                           │   │
│  │ }                                                                       │   │
│  │                                                                         │   │
│  │ 결과:                                                                    │   │
│  │ - Redis DB: 2                                                           │   │
│  │ - URL: redis://db.codeb.kr:6379/2                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ Phase 1-3: App Server (다시) - ENV 파일, SSOT, Caddy                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Step 6: ENV 파일 생성                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /opt/codeb/env/myapp/.env 생성                                        │   │
│  │                                                                         │   │
│  │ # CodeB v7.0 - Environment Variables                                   │   │
│  │ # Project: myapp                                                        │   │
│  │ # Domain: myapp.codeb.kr                                                │   │
│  │ # Generated: 2026-01-14T10:00:00Z                                       │   │
│  │                                                                         │   │
│  │ NODE_ENV=production                                                     │   │
│  │ PORT=3000                                                               │   │
│  │                                                                         │   │
│  │ # PostgreSQL (Storage Server: db.codeb.kr)                              │   │
│  │ DATABASE_URL=postgresql://myapp_user:xxx@db.codeb.kr:5432/myapp_db     │   │
│  │                                                                         │   │
│  │ # Redis (Storage Server: db.codeb.kr)                                   │   │
│  │ REDIS_URL=redis://db.codeb.kr:6379/2                                    │   │
│  │                                                                         │   │
│  │ # Centrifugo (WebSocket - Streaming Server: ws.codeb.kr)                │   │
│  │ NEXT_PUBLIC_WS_URL=wss://ws.codeb.kr/connection/websocket               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 7: ENV 백업                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ cp /opt/codeb/env/myapp/.env /opt/codeb/env-backup/myapp/.env.1705234800│   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 8: SSOT 업데이트 (전역)                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /opt/codeb/registry/ssot.json 업데이트                                 │   │
│  │ {                                                                       │   │
│  │   "version": "7.0",                                                     │   │
│  │   "projects": {                                                         │   │
│  │     "myapp": {                           ← 프로젝트 정보 추가            │   │
│  │       "teamId": "team_abc123",                                          │   │
│  │       "type": "nextjs",                                                 │   │
│  │       "ports": { "blue": 4102, "green": 4103 },                        │   │
│  │       "database": { "name": "myapp_db", "user": "myapp_user" },        │   │
│  │       "redis": { "db": 2 },                                             │   │
│  │       "domain": "myapp.codeb.kr",                                       │   │
│  │       "createdAt": "2026-01-14T10:00:00Z",                              │   │
│  │       "createdBy": "key_xyz789"                                         │   │
│  │     }                                                                   │   │
│  │   },                                                                    │   │
│  │   "ports": {                                                            │   │
│  │     "allocated": {                                                      │   │
│  │       "4100": { "project": "existing1", "slot": "blue" },              │   │
│  │       "4101": { "project": "existing1", "slot": "green" },             │   │
│  │       "4102": { "project": "myapp", "slot": "blue" },    ← 추가        │   │
│  │       "4103": { "project": "myapp", "slot": "green" }    ← 추가        │   │
│  │     }                                                                   │   │
│  │   }                                                                     │   │
│  │ }                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 9: Caddy 도메인 설정                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /etc/caddy/sites/myapp.caddy 생성                                     │   │
│  │                                                                         │   │
│  │ myapp.codeb.kr {                                                        │   │
│  │   reverse_proxy localhost:4102 localhost:4103 {                         │   │
│  │     lb_policy first        # 첫 번째(active)에 먼저 라우팅              │   │
│  │     fail_duration 10s      # 실패 시 10초 동안 우회                     │   │
│  │   }                                                                     │   │
│  │   encode gzip                                                           │   │
│  │   log {                                                                 │   │
│  │     output file /var/log/caddy/myapp.log                                │   │
│  │   }                                                                     │   │
│  │ }                                                                       │   │
│  │                                                                         │   │
│  │ systemctl reload caddy                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 10: PowerDNS A 레코드 (*.codeb.kr 도메인인 경우)                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ pdnsutil add-record codeb.kr myapp A 300 158.247.203.55                 │   │
│  │ pdnsutil rectify-zone codeb.kr                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 11: SSL 인증서 발급 대기 (Caddy 자동)                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # 최대 30초 대기, Caddy가 Let's Encrypt 인증서 자동 발급                 │   │
│  │ for i in 1..10; do                                                      │   │
│  │   curl -sI https://myapp.codeb.kr --connect-timeout 5                   │   │
│  │   if HTTP/200; break                                                    │   │
│  │   sleep 3                                                               │   │
│  │ done                                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1.4 초기화 결과

```json
{
  "success": true,
  "projectName": "myapp",
  "ports": { "blue": 4102, "green": 4103 },
  "database": {
    "name": "myapp_db",
    "user": "myapp_user",
    "url": "postgresql://myapp_user:xxx@db.codeb.kr:5432/myapp_db"
  },
  "redis": {
    "db": 2,
    "url": "redis://db.codeb.kr:6379/2"
  },
  "domain": "myapp.codeb.kr",
  "files": [
    "/opt/codeb/registry/slots/myapp-production.json",
    "/opt/codeb/env/myapp/.env",
    "/opt/codeb/registry/ssot.json",
    "/etc/caddy/sites/myapp.caddy"
  ]
}
```

---

## PHASE 2: 환경변수 동기화 (env_sync)

### 2.1 트리거

```bash
# 로컬 .env.production 파일이 있는 경우
/we:env sync
```

### 2.2 처리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ ENV 동기화 흐름                                                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  개발자 PC                              App Server                              │
│  ┌────────────────────┐                ┌────────────────────────────────────┐  │
│  │ .env.production    │                │                                    │  │
│  │                    │                │                                    │  │
│  │ DATABASE_URL=...   │   env_sync     │ /opt/codeb/env/myapp/.env          │  │
│  │ REDIS_URL=...      │ ─────────────→ │                                    │  │
│  │ STRIPE_KEY=...     │   (Base64)     │ 기존 ENV + 새로운 변수 병합         │  │
│  │ CUSTOM_VAR=...     │                │                                    │  │
│  └────────────────────┘                │ 백업: .env.{timestamp}             │  │
│                                        └────────────────────────────────────┘  │
│                                                                                 │
│  처리 단계:                                                                      │
│  1. 로컬 .env 파일 읽기                                                          │
│  2. KEY=VALUE 파싱                                                              │
│  3. SSOT에서 기존 변수 읽기 (merge 옵션)                                         │
│  4. Base64 인코딩 후 SSH 전송                                                   │
│  5. 서버 디렉토리 생성                                                           │
│  6. 백업 생성 (.env.backup.{timestamp})                                         │
│  7. 파일 저장 + chmod 600                                                       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## PHASE 3: 코드 푸시 & GitHub Actions

### 3.1 트리거

```bash
git push origin main
```

### 3.2 GitHub Actions 워크플로우 시작

```yaml
on:
  push:
    branches: [main]
```

---

## PHASE 4: 빌드 & 배포 (3가지 타입별)

### 4.1 공통: Docker 이미지 빌드 & Push

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Docker 빌드 단계 (모든 타입 공통)                                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  1. npm ci                    # 의존성 설치                                     │
│  2. npm run build             # 애플리케이션 빌드                               │
│  3. docker build              # Docker 이미지 생성                              │
│  4. docker push               # GHCR에 이미지 푸시                              │
│     → ghcr.io/org/myapp:abc123def                                               │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ Self-hosted: 서버에서 직접 빌드                                          │   │
│  │ SSH:         GitHub Runner에서 빌드 → GHCR Push                          │   │
│  │ API:         GitHub Runner에서 빌드 → GHCR Push                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 배포 분기 (3가지 타입)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              배포 타입별 분기                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                    ┌──────────────────────────────────────┐                     │
│                    │       Docker 이미지 준비 완료         │                     │
│                    │   ghcr.io/org/myapp:abc123def        │                     │
│                    └──────────────────────────────────────┘                     │
│                                      │                                          │
│            ┌─────────────────────────┼─────────────────────────┐                │
│            ▼                         ▼                         ▼                │
│   ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐       │
│   │ Type 1: Self-hosted│  │ Type 2: SSH        │  │ Type 3: API        │       │
│   ├────────────────────┤  ├────────────────────┤  ├────────────────────┤       │
│   │                    │  │                    │  │                    │       │
│   │ runs-on:           │  │ runs-on:           │  │ runs-on:           │       │
│   │ [self-hosted,docker]│ │ ubuntu-latest      │  │ ubuntu-latest      │       │
│   │                    │  │                    │  │                    │       │
│   │ 서버에서 직접:      │  │ SSH 접속:          │  │ API 호출:          │       │
│   │ • SSOT 읽기        │  │ • SSOT 읽기        │  │                    │       │
│   │ • 슬롯 결정        │  │ • 슬롯 결정        │  │ curl API 호출      │       │
│   │ • docker pull      │  │ • docker pull      │  │ → deploy_project   │       │
│   │ • docker run       │  │ • docker run       │  │                    │       │
│   │ • health check     │  │ • health check     │  │ API가 모든 것 처리  │       │
│   │ • registry 업데이트│  │ • registry 업데이트│  │                    │       │
│   │                    │  │                    │  │                    │       │
│   └────────────────────┘  └────────────────────┘  └────────────────────┘       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## PHASE 5: 서버 배포 처리 (deploy.ts)

### 5.1 MCP API 호출 (API 타입의 경우)

```
POST https://api.codeb.kr/api/tool
{
  "tool": "deploy_project",
  "params": {
    "projectName": "myapp",
    "image": "ghcr.io/org/myapp:abc123def",
    "environment": "production"
  }
}
```

### 5.2 서버 처리 단계 (deploy.ts)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Deploy 실행 단계 (App Server에서)                                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Step 1: 슬롯 상태 확인                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /opt/codeb/registry/slots/myapp-production.json 읽기                  │   │
│  │ {                                                                       │   │
│  │   "activeSlot": "blue",      ← 현재 blue가 활성                         │   │
│  │   "blue": { "state": "active", "port": 4102 },                         │   │
│  │   "green": { "state": "grace", "port": 4103 }   ← green에 배포 결정    │   │
│  │ }                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 2: 비활성 슬롯 선택                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ activeSlot = "blue" → targetSlot = "green"                              │   │
│  │ targetPort = 4103                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 3: Docker 이미지 Pull                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ docker pull ghcr.io/org/myapp:abc123def                                 │   │
│  │ # timeout: 180초                                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 4: 기존 컨테이너 정리                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ docker stop myapp-production-green || true                              │   │
│  │ docker rm myapp-production-green || true                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 5: 새 컨테이너 실행 (ENV 파일 사용)                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ docker run -d \                                                         │   │
│  │   --name myapp-production-green \                                       │   │
│  │   --restart always \                                                    │   │
│  │   --env-file /opt/codeb/projects/myapp/.env.production \   ← ENV 주입  │   │
│  │   -p 4103:3000 \                                            ← 포트 매핑 │   │
│  │   --health-cmd="curl -sf http://localhost:3000/health" \               │   │
│  │   --health-interval=10s \                                               │   │
│  │   --health-timeout=5s \                                                 │   │
│  │   --memory=512m \                                                       │   │
│  │   --cpus=1 \                                                            │   │
│  │   -l codeb.project=myapp \                                              │   │
│  │   -l codeb.slot=green \                                                 │   │
│  │   -l codeb.version=abc123def \                                          │   │
│  │   ghcr.io/org/myapp:abc123def                                           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 6: Health Check (3단계)                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # 1차: Docker healthcheck 상태 확인                                     │   │
│  │ docker inspect myapp-production-green --format '{{.State.Health.Status}}'│  │
│  │ → "healthy" | "unhealthy" | "starting"                                  │   │
│  │                                                                         │   │
│  │ # 2차: 컨테이너 내부에서 curl                                            │   │
│  │ docker exec myapp-production-green curl -sf http://localhost:3000/health│   │
│  │                                                                         │   │
│  │ # 3차: 호스트에서 직접 curl                                              │   │
│  │ curl -sf http://localhost:4103/health                                   │   │
│  │                                                                         │   │
│  │ # 최대 60초 대기, 5초 간격 재시도                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 7: 슬롯 레지스트리 업데이트                                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /opt/codeb/registry/slots/myapp-production.json 업데이트              │   │
│  │ {                                                                       │   │
│  │   "activeSlot": "blue",        ← 아직 blue가 active (트래픽 유지)       │   │
│  │   "blue": { "state": "active", "port": 4102, "version": "old123" },    │   │
│  │   "green": {                                                            │   │
│  │     "state": "deployed",       ← deployed로 변경                        │   │
│  │     "port": 4103,                                                       │   │
│  │     "version": "abc123def",                                             │   │
│  │     "image": "ghcr.io/org/myapp:abc123def",                             │   │
│  │     "deployedAt": "2026-01-14T10:30:00Z",                               │   │
│  │     "deployedBy": "key_xyz789",                                         │   │
│  │     "healthStatus": "healthy"                                           │   │
│  │   },                                                                    │   │
│  │   "lastUpdated": "2026-01-14T10:30:00Z"                                 │   │
│  │ }                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 배포 결과

```json
{
  "success": true,
  "slot": "green",
  "port": 4103,
  "previewUrl": "https://myapp-green.preview.codeb.kr",
  "steps": [
    { "name": "get_slot_status", "status": "success", "duration": 50 },
    { "name": "select_slot", "status": "success", "duration": 1 },
    { "name": "pull_image", "status": "success", "duration": 8500 },
    { "name": "cleanup_container", "status": "success", "duration": 200 },
    { "name": "start_container", "status": "success", "duration": 1500 },
    { "name": "health_check", "status": "success", "duration": 12000 },
    { "name": "update_registry", "status": "success", "duration": 30 }
  ],
  "duration": 22281
}
```

---

## PHASE 6: Promote (트래픽 전환)

### 6.1 트리거

```bash
gh workflow run deploy.yml -f action=promote
# 또는
/we:promote myapp
```

### 6.2 서버 처리 (promote.ts)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Promote 실행 단계                                                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Step 1: deployed 슬롯 확인                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # 슬롯 레지스트리에서 state="deployed" 찾기                              │   │
│  │ green.state === "deployed" → green을 active로 전환                      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 2: Health Check (승격 전)                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ curl -sf http://localhost:4103/health                                   │   │
│  │ → 200 OK 확인                                                           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 3: Caddy 설정 업데이트                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # /etc/caddy/sites/myapp.caddy 수정                                     │   │
│  │                                                                         │   │
│  │ myapp.codeb.kr {                                                        │   │
│  │   reverse_proxy localhost:4103 localhost:4102 {  ← 순서 변경!           │   │
│  │     lb_policy first      # 4103(green)에 먼저 라우팅                    │   │
│  │     fail_duration 10s                                                   │   │
│  │   }                                                                     │   │
│  │ }                                                                       │   │
│  │                                                                         │   │
│  │ systemctl reload caddy   # 무중단 리로드                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 4: 슬롯 상태 업데이트                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ # 슬롯 레지스트리 업데이트                                               │   │
│  │ {                                                                       │   │
│  │   "activeSlot": "green",       ← green으로 변경                         │   │
│  │   "blue": {                                                             │   │
│  │     "state": "grace",          ← grace로 변경 (48시간 유지)             │   │
│  │     "graceExpiresAt": "2026-01-16T10:30:00Z"                            │   │
│  │   },                                                                    │   │
│  │   "green": {                                                            │   │
│  │     "state": "active",         ← active로 변경                          │   │
│  │     "promotedAt": "2026-01-14T10:35:00Z"                                │   │
│  │   }                                                                     │   │
│  │ }                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## PHASE 7: Rollback (필요시)

### 7.1 트리거

```bash
gh workflow run deploy.yml -f action=rollback
# 또는
/we:rollback myapp
```

### 7.2 서버 처리

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Rollback 실행 단계                                                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Step 1: grace 슬롯 확인                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ blue.state === "grace" → blue로 롤백                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 2: grace 슬롯 Health Check                                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ curl -sf http://localhost:4102/health → 200 OK                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 3: Caddy 설정 되돌리기                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ reverse_proxy localhost:4102 localhost:4103  ← 순서 원복                │   │
│  │ systemctl reload caddy                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 4: 슬롯 상태 복원                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ blue: grace → active                                                    │   │
│  │ green: active → deployed                                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 슬롯 상태 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              슬롯 상태 전이                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                                                                                 │
│    ┌─────────┐      deploy      ┌──────────┐     promote     ┌─────────┐       │
│    │  empty  │ ───────────────→ │ deployed │ ──────────────→ │ active  │       │
│    └─────────┘                  └──────────┘                 └────┬────┘       │
│         ▲                                                         │            │
│         │                                                         │            │
│         │ cleanup                          promote (다른 slot)    │            │
│         │ (48시간 후)                                              │            │
│         │                                                         ▼            │
│    ┌─────────┐                                              ┌─────────┐        │
│    │  empty  │ ←─────────────────────────────────────────── │  grace  │        │
│    └─────────┘               graceExpiresAt                 │(48시간) │        │
│                                                             └────┬────┘        │
│                                                                  │             │
│                                              rollback            │             │
│                                                                  ▼             │
│                                                             ┌─────────┐        │
│                                                             │ active  │        │
│                                                             └─────────┘        │
│                                                                                 │
│  상태 설명:                                                                      │
│  • empty:    컨테이너 없음                                                       │
│  • deployed: 컨테이너 실행 중, 트래픽 없음 (Preview URL로 테스트 가능)           │
│  • active:   트래픽 받는 중 (Production URL)                                    │
│  • grace:    이전 버전, 48시간 유지 (롤백 대기)                                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 파일 경로 요약

| 용도 | 경로 |
|------|------|
| **전역 SSOT** | `/opt/codeb/registry/ssot.json` |
| **슬롯 레지스트리** | `/opt/codeb/registry/slots/{project}-{env}.json` |
| **Redis DB 할당** | `/opt/codeb/registry/redis-db.json` |
| **ENV 파일** | `/opt/codeb/env/{project}/.env` |
| **ENV 백업** | `/opt/codeb/env-backup/{project}/.env.{timestamp}` |
| **Caddy 설정** | `/etc/caddy/sites/{project}.caddy` |
| **프로젝트 디렉토리** | `/opt/codeb/projects/{project}/` |

---

## 3가지 타입별 처리 차이

| 단계 | Self-hosted | SSH | API |
|------|-------------|-----|-----|
| **SSOT 읽기** | 직접 파일 읽기 | SSH로 파일 읽기 | API가 읽고 응답 |
| **슬롯 결정** | 직접 계산 | SSH 스크립트 | API 내부 로직 |
| **ENV 주입** | --env-file 직접 | SSH로 --env-file | API가 자동 주입 |
| **포트 매핑** | 직접 -p 옵션 | SSH로 -p 옵션 | API가 SSOT에서 조회 |
| **docker run** | 직접 실행 | SSH로 실행 | API가 SSH로 실행 |
| **Health Check** | 직접 curl | SSH로 curl | API 내장 로직 |
| **Registry 업데이트** | 직접 파일 쓰기 | SSH로 파일 쓰기 | API가 자동 업데이트 |
| **Caddy 설정** | 직접 파일 수정 | SSH로 수정 | API가 자동 생성 |

---

> **문서 끝** | CodeB Hybrid Deployment v7.0.40
